import React, { useState, useEffect, useRef } from 'react';
import electronAPI from '../utils/electronAPI';
import { apiFetch, getAISummary, getAIPlan, analyzeFilesAI, analyzeSearchResultsAI, recommendOrganizationAI, chatWithAI } from '../utils/api';
import { 
  FolderIcon, 
  DocumentIcon, 
  PhotoIcon, 
  VideoCameraIcon, 
  MusicalNoteIcon, 
  ArchiveBoxIcon,
  MagnifyingGlassIcon,
  PlusIcon,
  TrashIcon,
  ArrowUpIcon,
  Cog6ToothIcon,
  SparklesIcon,
  ChartBarIcon,
  CloudIcon,
  ShieldCheckIcon,
  ClockIcon,
  StarIcon,
  EyeIcon,
  PencilIcon,
  DocumentDuplicateIcon,
  ArrowPathIcon,
  FunnelIcon,
  ViewColumnsIcon,
  Squares2X2Icon,
  ListBulletIcon,
  MoonIcon,
  SunIcon,
  HomeIcon,
  ComputerDesktopIcon,
  FolderOpenIcon,
  BoltIcon,
  CpuChipIcon,
  CommandLineIcon,
  BeakerIcon,
  RocketLaunchIcon,
  FireIcon,
  LightBulbIcon,
  GlobeAltIcon,
  ChatBubbleLeftRightIcon,
  UserGroupIcon,
  PaperAirplaneIcon,
  ArrowDownTrayIcon,
  CalendarIcon,
  CodeBracketIcon,
  FilmIcon,
  PresentationChartLineIcon,
  DocumentTextIcon,
  CubeIcon,
  LanguageIcon,
  ChevronDownIcon,
  ChevronUpIcon,
  Bars3BottomLeftIcon // í–„ë²„ê±° 5ì¤„ ì•„ì´ì½˜ ì¶”ê°€
} from '@heroicons/react/24/outline';

import {
  FolderIcon as FolderSolidIcon,
  DocumentIcon as DocumentSolidIcon,
  PhotoIcon as PhotoSolidIcon,
  SparklesIcon as SparklesSolidIcon,
  HeartIcon as HeartSolidIcon,
  ChatBubbleLeftRightIcon as ChatSolidIcon,
  UserIcon as UserSolidIcon
} from '@heroicons/react/24/solid';

// ìŠ¤í¬ë¡¤ë°” ìˆ¨ê¹€ì„ ìœ„í•œ CSS ìŠ¤íƒ€ì¼ ì¶”ê°€
const hideScrollbarStyle = `
  .hide-scrollbar::-webkit-scrollbar {
    display: none;
  }
  .hide-scrollbar {
    -ms-overflow-style: none;
    scrollbar-width: none;
  }
`;

export default function FileExplorer() {
  const [currentPath, setCurrentPath] = useState('');
  const [files, setFiles] = useState([]);
  const [preview, setPreview] = useState(null);
  const [aiResult, setAiResult] = useState(null);
  const [fileIcons, setFileIcons] = useState({}); // íŒŒì¼ ì•„ì´ì½˜ ìºì‹œ
  const [loading, setLoading] = useState(false);
  const [chatInput, setChatInput] = useState('');
  const [chatHistory, setChatHistory] = useState([]);
  const [aiThinking, setAiThinking] = useState(false);
  const [aiSuggestions, setAiSuggestions] = useState([]);
  const [contextAwareness, setContextAwareness] = useState({
    currentFolder: '',
    fileCount: 0,
    fileTypes: [],
    recentActivity: []
  });
  const [selectedFiles, setSelectedFiles] = useState([]);
  const [viewMode, setViewMode] = useState('grid');
  const [sortBy, setSortBy] = useState('name');
  const [sortOrder, setSortOrder] = useState('asc');
  const [searchQuery, setSearchQuery] = useState('');
  const [showSidebar, setShowSidebar] = useState(true);
  const [breadcrumbs, setBreadcrumbs] = useState([]);
  const [drives, setDrives] = useState([]);
  const [dragOver, setDragOver] = useState(false);
  const [contextMenu, setContextMenu] = useState({ show: false, x: 0, y: 0, target: null });
  const [darkMode, setDarkMode] = useState(false);
  const [aiChatExpanded, setAiChatExpanded] = useState(false);
  const [activeFilters, setActiveFilters] = useState(['all']);
  const [messengerExpanded, setMessengerExpanded] = useState(false);
  const [messengerInput, setMessengerInput] = useState('');
  const [messages, setMessages] = useState([]);
  const [onlineUsers, setOnlineUsers] = useState([
    { 
      id: 1, 
      name: 'ê¹€ì² ìˆ˜', 
      status: 'online', 
      avatar: 'KCS',
      avatarColor: 'from-blue-500 to-blue-600',
      title: 'í”„ë¡œì íŠ¸ ë§¤ë‹ˆì €',
      lastSeen: null
    },
    { 
      id: 2, 
      name: 'ì´ì˜í¬', 
      status: 'away', 
      avatar: 'LYH',
      avatarColor: 'from-green-500 to-green-600',
      title: 'í”„ë¡ íŠ¸ì—”ë“œ ê°œë°œìž',
      lastSeen: '5ë¶„ ì „'
    },
    { 
      id: 3, 
      name: 'ë°•ë¯¼ìˆ˜', 
      status: 'online', 
      avatar: 'PMS',
      avatarColor: 'from-purple-500 to-purple-600',
      title: 'ë°±ì—”ë“œ ê°œë°œìž',
      lastSeen: null
    },
    { 
      id: 4, 
      name: 'ìµœì§€ì›', 
      status: 'offline', 
      avatar: 'CJW',
      avatarColor: 'from-pink-500 to-pink-600',
      title: 'UI/UX ë””ìžì´ë„ˆ',
      lastSeen: '2ì‹œê°„ ì „'
    },
    { 
      id: 5, 
      name: 'ì •ë¯¼í˜¸', 
      status: 'busy', 
      avatar: 'JMH',
      avatarColor: 'from-orange-500 to-orange-600',
      title: 'DevOps ì—”ì§€ë‹ˆì–´',
      lastSeen: null
    }
  ]);
  const [favorites, setFavorites] = useState([]);
  const [favoritesCollapsed, setFavoritesCollapsed] = useState(false);
  const [showUserList, setShowUserList] = useState(false);
  const [showMenuBar, setShowMenuBar] = useState(true);
  const [userListCollapsed, setUserListCollapsed] = useState(false);
  const [selectedMenuItem, setSelectedMenuItem] = useState('home');
  const [advancedSearchOpen, setAdvancedSearchOpen] = useState(false);
  const [backupPanelOpen, setBackupPanelOpen] = useState(false);
  const [securityPanelOpen, setSecurityPanelOpen] = useState(false);
  const [optimizePanelOpen, setOptimizePanelOpen] = useState(false);
  const [cloudPanelOpen, setCloudPanelOpen] = useState(false);
  const [searchHistory, setSearchHistory] = useState([]);
  const [recentFiles, setRecentFiles] = useState([]);
  const [duplicateFiles, setDuplicateFiles] = useState([]);
  const [encryptedFiles, setEncryptedFiles] = useState([]);
  const [searchParams, setSearchParams] = useState({
    filename: '',
    extensions: [],
    minSize: '',
    maxSize: '',
    startDate: '',
    endDate: ''
  });
  const [searchResults, setSearchResults] = useState([]);
  const [searchLoading, setSearchLoading] = useState(false);
  const [userProfilePopup, setUserProfilePopup] = useState({ show: false, user: null, x: 0, y: 0 });
  const [currentUserActivity, setCurrentUserActivity] = useState({
    viewingFile: null,
    lastAction: null,
    timestamp: null
  });
  const fileInputRef = useRef(null);

  // ìœ ì € í”„ë¡œí•„ ì •ë³´
  const [userProfile] = useState({
    name: 'í™ê¸¸ë™',
    avatar: 'ðŸ¦¸â€â™‚ï¸',
    status: 'online',
    email: 'hong@company.com',
  });

  // íŒŒì¼ í•„í„° ì‹œìŠ¤í…œ (ê¸°ì¡´ ë¹ ë¥¸ ì•¡ì„¸ìŠ¤ ê°œì„ )
  const fileFilters = [
    { 
      id: 'all', 
      label: 'ëª¨ë“  íŒŒì¼', 
      icon: FolderIcon, 
      color: 'text-gray-500',
      gradient: 'from-gray-500 to-gray-600',
      filter: () => true
    },
    { 
      id: 'recent', 
      label: 'ìµœê·¼ íŒŒì¼', 
      icon: ClockIcon, 
      color: 'text-violet-500',
      gradient: 'from-violet-500 to-purple-500',
      filter: (file) => {
        const fileDate = new Date(file.modified);
        const now = new Date();
        const daysDiff = (now - fileDate) / (1000 * 60 * 60 * 24);
        return daysDiff <= 7; // 7ì¼ ì´ë‚´
      }
    },
    { 
      id: 'group', 
      label: 'ê·¸ë£¹', 
      icon: ViewColumnsIcon, 
      color: 'text-emerald-500',
      gradient: 'from-emerald-500 to-teal-500',
      filter: () => true // ëª¨ë“  íŒŒì¼ í‘œì‹œí•˜ë˜ ê·¸ë£¹ìœ¼ë¡œ ë‚˜ëˆ„ì–´ í‘œì‹œ
    },
    { 
      id: 'images', 
      label: 'ì´ë¯¸ì§€', 
      icon: PhotoIcon, 
      color: 'text-pink-500',
      gradient: 'from-pink-500 to-rose-500',
      filter: (file) => /\.(jpg|jpeg|png|gif|bmp|svg|webp|tiff|tif|ico|psd|ai|eps|raw|cr2|nef|dng)$/i.test(file.name)
    },
    { 
      id: 'documents', 
      label: 'ë¬¸ì„œ', 
      icon: DocumentTextIcon, 
      color: 'text-blue-500',
      gradient: 'from-blue-500 to-indigo-500',
      filter: (file) => /\.(pdf|doc|docx|txt|rtf|odt|xls|xlsx|ppt|pptx|pages|numbers|keynote|md|tex)$/i.test(file.name)
    },
    { 
      id: 'videos', 
      label: 'ë™ì˜ìƒ', 
      icon: FilmIcon, 
      color: 'text-purple-500',
      gradient: 'from-purple-500 to-violet-500',
      filter: (file) => /\.(mp4|avi|mov|mkv|wmv|flv|webm|m4v|3gp|ogv|mpg|mpeg|m2v|vob)$/i.test(file.name)
    },
    { 
      id: 'music', 
      label: 'ìŒì•…', 
      icon: MusicalNoteIcon, 
      color: 'text-green-500',
      gradient: 'from-green-500 to-emerald-500',
      filter: (file) => /\.(mp3|wav|flac|aac|ogg|wma|m4a|opus|ape|mka)$/i.test(file.name)
    },
    { 
      id: 'code', 
      label: 'ì½”ë“œ', 
      icon: CodeBracketIcon, 
      color: 'text-orange-500',
      gradient: 'from-orange-500 to-red-500',
      filter: (file) => /\.(js|jsx|ts|tsx|py|java|cpp|c|h|html|css|scss|sass|php|rb|go|rs|swift|kt|scala|pl|sh|bat|ps1|sql|json|xml|yaml|yml|toml|ini|cfg|conf)$/i.test(file.name)
    },
    { 
      id: 'cad', 
      label: 'CAD/3D', 
      icon: CubeIcon, 
      color: 'text-emerald-500',
      gradient: 'from-emerald-500 to-green-500',
      filter: (file) => /\.(dwg|dxf|dwf|skp|step|stp|iges|igs|catpart|catproduct|prt|asm|ipt|iam|sldprt|sldasm|slddrw|3dm|rvt|rfa|rte|rft|fcstd)$/i.test(file.name)
    },
    { 
      id: 'executable', 
      label: 'ì‹¤í–‰íŒŒì¼', 
      icon: CpuChipIcon, 
      color: 'text-red-500',
      gradient: 'from-red-500 to-pink-500',
      filter: (file) => /\.(exe|msi|dmg|pkg|deb|rpm|app|apk|ipa|run|bin|com|scr|bat|cmd|ps1|vbs|jar|war)$/i.test(file.name)
    },
    { 
      id: 'archives', 
      label: 'ì••ì¶•íŒŒì¼', 
      icon: ArchiveBoxIcon, 
      color: 'text-yellow-500',
      gradient: 'from-yellow-500 to-amber-500',
      filter: (file) => /\.(zip|rar|7z|tar|gz|bz2|xz|lzma|iso|dmg|img|vhd|vmdk|ova|cab|ace|lha)$/i.test(file.name)
    },
    { 
      id: 'system', 
      label: 'ì‹œìŠ¤í…œ', 
      icon: Cog6ToothIcon, 
      color: 'text-slate-500',
      gradient: 'from-slate-500 to-gray-500',
      filter: (file) => /\.(dll|sys|drv|ini|cfg|conf|log|tmp|cache|dat|db|sqlite|reg|lnk|url|desktop)$/i.test(file.name)
    },
    { 
      id: 'fonts', 
      label: 'í°íŠ¸', 
      icon: LanguageIcon, 
      color: 'text-indigo-500',
      gradient: 'from-indigo-500 to-purple-500',
      filter: (file) => /\.(ttf|otf|woff|woff2|eot|fon|pfb|pfm|afm)$/i.test(file.name)
    }
  ];

  // ê¸°ë³¸ ì‹œìŠ¤í…œ í´ë”ë“¤ (ìžë™ìœ¼ë¡œ ì¦ê²¨ì°¾ê¸°ì— ì¶”ê°€ë  í•­ëª©ë“¤)
  const defaultSystemFolders = [
    { 
      id: 'desktop', 
      label: 'ë°”íƒ•í™”ë©´', 
      icon: ComputerDesktopIcon, 
      gradient: 'from-blue-500 to-cyan-500',
      path: process.env.USERPROFILE ? `${process.env.USERPROFILE}\\Desktop` : 'C:\\Users\\Public\\Desktop',
      type: 'system'
    },
    { 
      id: 'documents', 
      label: 'ë¬¸ì„œ', 
      icon: DocumentIcon, 
      gradient: 'from-orange-500 to-red-500',
      path: process.env.USERPROFILE ? `${process.env.USERPROFILE}\\Documents` : 'C:\\Users\\Public\\Documents',
      type: 'system'
    },
    { 
      id: 'downloads', 
      label: 'ë‹¤ìš´ë¡œë“œ', 
      icon: ArrowDownTrayIcon, 
      gradient: 'from-green-500 to-emerald-500',
      path: process.env.USERPROFILE ? `${process.env.USERPROFILE}\\Downloads` : 'C:\\Users\\Public\\Downloads',
      type: 'system'
    }
  ];

  const getThisPC = () => [
    { 
      id: 'user-folder', 
      label: userProfile.name, 
      icon: UserSolidIcon, 
      gradient: 'from-blue-400 to-blue-600',
      path: process.env.USERPROFILE || 'C:\\Users\\Public',
      type: 'user'
    }
  ];

  // AI ê¸°ëŠ¥ ë©”ë‰´
  const aiFeatures = [
    { 
      id: 'ai-copilot', 
      label: 'AI ì½”íŒŒì¼ëŸ¿', 
      icon: SparklesIcon,
      gradient: 'from-purple-500 to-pink-500',
      description: 'ìžì—°ì–´ë¡œ íŒŒì¼ ê´€ë¦¬',
      action: () => setAiChatExpanded(true)
    },
    { 
      id: 'smart-search', 
      label: 'ìŠ¤ë§ˆíŠ¸ ê²€ìƒ‰', 
      icon: MagnifyingGlassIcon,
      gradient: 'from-blue-500 to-cyan-500',
      description: 'AI ê¸°ë°˜ ë‚´ìš© ê²€ìƒ‰',
      action: () => setAdvancedSearchOpen(true)
    },
    { 
      id: 'file-analysis', 
      label: 'íŒŒì¼ ë¶„ì„', 
      icon: CpuChipIcon,
      gradient: 'from-emerald-500 to-green-500',
      description: 'ì„ íƒëœ íŒŒì¼ AI ë¶„ì„',
      action: () => handleSelectedFilesAnalysis('summary')
    },
    { 
      id: 'search-analysis', 
      label: 'ê²€ìƒ‰ ê²°ê³¼ ë¶„ì„', 
      icon: ChartBarIcon,
      gradient: 'from-orange-500 to-red-500',
      description: 'ê²€ìƒ‰ ê²°ê³¼ AI ë¶„ì„',
      action: () => handleSearchResultsAnalysis(files, searchQuery || 'í˜„ìž¬ í´ë”')
    },
    { 
      id: 'auto-organize', 
      label: 'ìžë™ ì •ë¦¬', 
      icon: BoltIcon,
      gradient: 'from-yellow-500 to-orange-500',
      description: 'íŒŒì¼ ìžë™ ë¶„ë¥˜ ë° ì •ë¦¬',
      action: () => handleOrganizationRecommendation()
    },
    { 
      id: 'content-analysis', 
      label: 'ë‚´ìš© ë¶„ì„', 
      icon: DocumentTextIcon,
      gradient: 'from-indigo-500 to-purple-500',
      description: 'ë¬¸ì„œ ìš”ì•½ ë° ë¶„ì„',
      action: () => handleSelectedFilesAnalysis('classification')
    }
  ];

  // í”„ë¡œíŽ˜ì…”ë„ íˆ´
  const professionalTools = [
    { id: 'backup', label: 'ë°±ì—…', icon: CloudIcon, color: 'text-blue-500' },
    { id: 'security', label: 'ë³´ì•ˆ', icon: ShieldCheckIcon, color: 'text-red-500' },
    { id: 'sync', label: 'ë™ê¸°í™”', icon: ArrowPathIcon, color: 'text-indigo-500' },
    { id: 'analytics', label: 'ë¶„ì„', icon: ChartBarIcon, color: 'text-green-500' }
  ];

  // ë©”ë‰´ë°” ì•„ì´í…œë“¤ (ë°±ì—”ë“œ ê¸°ëŠ¥ ì—°ë™)
  const menuItems = [
    { id: 'home', icon: HomeIcon, label: 'í™ˆ', color: 'text-blue-500' },
    { id: 'search', icon: MagnifyingGlassIcon, label: 'ê³ ê¸‰ ê²€ìƒ‰', color: 'text-green-500' },
    { id: 'backup', icon: CloudIcon, label: 'ë°±ì—…', color: 'text-purple-500' },
    { id: 'security', icon: ShieldCheckIcon, label: 'ë³´ì•ˆ', color: 'text-red-500' },
    { id: 'optimize', icon: BoltIcon, label: 'ìµœì í™”', color: 'text-yellow-500' },
    { id: 'cloud', icon: GlobeAltIcon, label: 'í´ë¼ìš°ë“œ', color: 'text-indigo-500' },
    { id: 'settings', icon: Cog6ToothIcon, label: 'ì„¤ì •', color: 'text-gray-500' }
  ];

  useEffect(() => {
    initializeExplorer();
    const mediaQuery = window.matchMedia('(prefers-color-scheme: dark)');
    setDarkMode(mediaQuery.matches);
    
    const handleChange = (e) => setDarkMode(e.matches);
    mediaQuery.addEventListener('change', handleChange);
    
    return () => mediaQuery.removeEventListener('change', handleChange);
  }, []);

  // í´ë” ì´ë™ ì‹œ í•„í„° ì´ˆê¸°í™”
  useEffect(() => {
    setActiveFilters(['all']);
  }, [currentPath]);

  useEffect(() => {
    if (darkMode) {
      document.documentElement.classList.add('dark');
    } else {
      document.documentElement.classList.remove('dark');
    }
  }, [darkMode]);

  // ì¦ê²¨ì°¾ê¸°ê°€ 10ê°œ ì´ìƒì¼ ë•Œ ìžë™ìœ¼ë¡œ ì ‘ê¸°
  useEffect(() => {
    if (favorites.length >= 10 && !favoritesCollapsed) {
      setFavoritesCollapsed(true);
    }
  }, [favorites.length]);

  const initializeExplorer = async () => {
    try {
      const drivesList = await electronAPI.listDrives();
      setDrives(drivesList);
      
      // ê¸°ë³¸ ì‹œìŠ¤í…œ í´ë”ë“¤ì„ ì¦ê²¨ì°¾ê¸°ì— ì¶”ê°€
      if (favorites.length === 0) {
        setFavorites(defaultSystemFolders.map(folder => ({
          ...folder,
          id: `default-${folder.id}`,
          type: 'default'
        })));
      }
      
      // ê¸°ë³¸ì ìœ¼ë¡œ Desktopë¶€í„° ì‹œìž‘
      const defaultPath = defaultSystemFolders[0].path;
      setCurrentPath(defaultPath);
      loadFiles(defaultPath);
      updateBreadcrumbs(defaultPath);
    } catch (error) {
      console.error('ì´ˆê¸°í™” ì‹¤íŒ¨:', error);
    }
  };

  const updateBreadcrumbs = (path) => {
    const parts = path.split(/[\\/]/).filter(Boolean);
    const breadcrumbItems = [];
    let currentPath = '';
    
    parts.forEach((part, index) => {
      currentPath += (index === 0 ? '' : '\\') + part;
      breadcrumbItems.push({
        name: part,
        path: currentPath
      });
    });
    
    setBreadcrumbs(breadcrumbItems);
  };

  const handleQuickAccessClick = async (folder) => {
    try {
      setCurrentPath(folder.path);
      await loadFiles(folder.path);
      updateBreadcrumbs(folder.path);
    } catch (error) {
      console.error('í´ë” ì ‘ê·¼ ì‹¤íŒ¨:', error);
    }
  };

  // ì¦ê²¨ì°¾ê¸° ê´€ë ¨ í•¨ìˆ˜ë“¤
  const toggleFavorite = (item) => {
    const isCurrentlyFavorite = favorites.some(fav => fav.path === item.path);
    
    if (isCurrentlyFavorite) {
      // ì¦ê²¨ì°¾ê¸°ì—ì„œ ì œê±°
      setFavorites(prev => prev.filter(fav => fav.path !== item.path));
    } else {
      // ì¦ê²¨ì°¾ê¸°ì— ì¶”ê°€
      const favoriteItem = {
        id: `fav-${Date.now()}`,
        label: item.isDirectory ? item.name : item.name.split('\\').pop(),
        path: item.path || item.fullPath,
        icon: item.isDirectory ? FolderIcon : getFileIcon(item),
        gradient: 'from-yellow-400 to-orange-500',
        type: 'favorite',
        addedAt: new Date()
      };
      setFavorites(prev => [...prev, favoriteItem]);
    }
  };

  const isFavorite = (path) => {
    return favorites.some(fav => fav.path === path);
  };

  // ë©”ë‰´ ì•„ì´í…œ í´ë¦­ í•¸ë“¤ëŸ¬
  const handleMenuClick = (menuId) => {
    setSelectedMenuItem(menuId);
    
    // ê¸°ì¡´ íŒ¨ë„ë“¤ ëª¨ë‘ ë‹«ê¸°
    setAdvancedSearchOpen(false);
    setBackupPanelOpen(false);
    setSecurityPanelOpen(false);
    setOptimizePanelOpen(false);
    setCloudPanelOpen(false);
    
    // ì„ íƒëœ ë©”ë‰´ì— ë”°ë¼ íŒ¨ë„ ì—´ê¸°
    switch (menuId) {
      case 'search':
        setAdvancedSearchOpen(true);
        break;
      case 'backup':
        setBackupPanelOpen(true);
        loadBackupData();
        break;
      case 'security':
        setSecurityPanelOpen(true);
        loadEncryptedFiles();
        break;
      case 'optimize':
        setOptimizePanelOpen(true);
        loadOptimizeData();
        break;
      case 'cloud':
        setCloudPanelOpen(true);
        loadCloudStorageData();
        break;
      default:
        break;
    }
  };

  // ë°±ì—”ë“œ API í˜¸ì¶œ í•¨ìˆ˜ë“¤
  const loadBackupData = async () => {
    try {
      const response = await apiFetch('/api/backup/list', {
        method: 'GET',
        headers: { 'Content-Type': 'application/json' }
      });
      console.log('ë°±ì—… ë°ì´í„° ë¡œë”© ì™„ë£Œ:', response);
    } catch (error) {
      console.error('ë°±ì—… ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', error);
    }
  };

  const loadOptimizeData = async () => {
    try {
      const response = await apiFetch('/api/optimize/duplicates', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ path: currentPath })
      });
      setDuplicateFiles(response.duplicates || []);
    } catch (error) {
      console.error('ìµœì í™” ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', error);
    }
  };

  const handleAdvancedSearch = async () => {
    setSearchLoading(true);
    try {
      const response = await apiFetch('/api/search/advanced', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          path: currentPath,
          filename: searchParams.filename,
          extensions: searchParams.extensions,
          minSize: searchParams.minSize,
          maxSize: searchParams.maxSize,
          startDate: searchParams.startDate,
          endDate: searchParams.endDate
        })
      });
      setSearchResults(response.results || []);
      setFiles(response.results || []);
      setAdvancedSearchOpen(false);
    } catch (error) {
      console.error('ê³ ê¸‰ ê²€ìƒ‰ ì‹¤íŒ¨:', error);
    } finally {
      setSearchLoading(false);
    }
  };

  const handleEncryptFile = async (filePath) => {
    try {
      const response = await apiFetch('/api/security/encrypt', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ filePath, password: 'default' })
      });
      if (response.success) {
        await loadEncryptedFiles();
      }
    } catch (error) {
      console.error('íŒŒì¼ ì•”í˜¸í™” ì‹¤íŒ¨:', error);
    }
  };

  const handleDecryptFile = async (filePath) => {
    try {
      const response = await apiFetch('/api/security/decrypt', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ filePath, password: 'default' })
      });
      if (response.success) {
        await loadEncryptedFiles();
      }
    } catch (error) {
      console.error('íŒŒì¼ ë³µí˜¸í™” ì‹¤íŒ¨:', error);
    }
  };

  const loadEncryptedFiles = async () => {
    try {
      const response = await apiFetch('/api/security/list-encrypted', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ path: currentPath })
      });
      setEncryptedFiles(response.files || []);
    } catch (error) {
      console.error('ì•”í˜¸í™” íŒŒì¼ ëª©ë¡ ë¡œë”© ì‹¤íŒ¨:', error);
    }
  };

  const handleCreateBackup = async () => {
    try {
      const response = await apiFetch('/api/backup/create', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ path: currentPath })
      });
      if (response.success) {
        console.log('ë°±ì—… ìƒì„± ì™„ë£Œ');
      }
    } catch (error) {
      console.error('ë°±ì—… ìƒì„± ì‹¤íŒ¨:', error);
    }
  };

  const handleRestoreBackup = async () => {
    try {
      const response = await apiFetch('/api/backup/restore', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ path: currentPath })
      });
      if (response.success) {
        console.log('ë°±ì—… ë³µì› ì™„ë£Œ');
        await loadFiles(currentPath);
      }
    } catch (error) {
      console.error('ë°±ì—… ë³µì› ì‹¤íŒ¨:', error);
    }
  };


  const loadCloudStorageData = async () => {
    try {
      const response = await apiFetch('/api/cloud/storage/status', {
        method: 'GET',
        headers: { 'Content-Type': 'application/json' }
      });
      console.log('í´ë¼ìš°ë“œ ìŠ¤í† ë¦¬ì§€ ìƒíƒœ:', response);
    } catch (error) {
      console.error('í´ë¼ìš°ë“œ ìŠ¤í† ë¦¬ì§€ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', error);
    }
  };

  const handleCloudSync = async (provider) => {
    try {
      const response = await apiFetch(`/api/cloud/${provider}/sync`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ path: currentPath })
      });
      if (response.success) {
        console.log(`${provider} ë™ê¸°í™” ì™„ë£Œ`);
      }
    } catch (error) {
      console.error(`${provider} ë™ê¸°í™” ì‹¤íŒ¨:`, error);
    }
  };

  const handleCloudUpload = async (provider) => {
    try {
      const response = await apiFetch(`/api/cloud/${provider}/upload`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ 
          files: selectedFiles.map(f => f.path),
          targetPath: currentPath 
        })
      });
      if (response.success) {
        console.log(`${provider} ì—…ë¡œë“œ ì™„ë£Œ`);
      }
    } catch (error) {
      console.error(`${provider} ì—…ë¡œë“œ ì‹¤íŒ¨:`, error);
    }
  };

  // ì‚¬ìš©ìž í™œë™ ë¸Œë¡œë“œìºìŠ¤íŠ¸
  const broadcastUserActivity = async (activity) => {
    try {
      // ì‹¤ì œë¡œëŠ” WebSocketì´ë‚˜ SSEë¡œ ì „ì†¡
      await apiFetch('/api/user/activity', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          userId: 'current-user',
          ...activity
        })
      });
    } catch (error) {
      console.error('ì‚¬ìš©ìž í™œë™ ì „ì†¡ ì‹¤íŒ¨:', error);
    }
  };

  // ì‚¬ìš©ìž í”„ë¡œí•„ í´ë¦­ í•¸ë“¤ëŸ¬
  const handleUserProfileClick = (user, event) => {
    event.stopPropagation();
    const rect = event.currentTarget.getBoundingClientRect();
    console.log('ì‚¬ìš©ìž í”„ë¡œí•„ í´ë¦­:', user.name);
    setUserProfilePopup({
      show: true,
      user: user,
      x: rect.right + 10,
      y: rect.top
    });
  };

  // ì‹œê°„ í¬ë§· í•¨ìˆ˜
  const formatTimeAgo = (timestamp) => {
    const now = new Date();
    const diff = now - new Date(timestamp);
    const minutes = Math.floor(diff / 60000);
    
    if (minutes < 1) return 'ë°©ê¸ˆ ì „';
    if (minutes < 60) return `${minutes}ëµ” ì „`;
    if (minutes < 1440) return `${Math.floor(minutes / 60)}ì‹œê°„ ì „`;
    return `${Math.floor(minutes / 1440)}ì¼ ì „`;
  };

  // ë©”ì‹œì§€ ì „ì†¡ í•¨ìˆ˜
  const sendMessageToUser = (userId, message) => {
    const targetUser = onlineUsers.find(u => u.id === userId);
    if (targetUser) {
      const newMessage = {
        id: Date.now(),
        sender: 'ë‚˜',
        recipient: targetUser.name,
        content: message,
        timestamp: new Date(),
        type: 'direct'
      };
      setMessages(prev => [...prev, newMessage]);
      setMessengerExpanded(true);
      setUserProfilePopup({ show: false, user: null, x: 0, y: 0 });
    }
  };

  // íŒŒì¼ ê³µìœ  í•¨ìˆ˜
  const shareFileWithUser = (userId, file) => {
    const targetUser = onlineUsers.find(u => u.id === userId);
    if (targetUser && file) {
      const shareMessage = {
        id: Date.now(),
        sender: 'ë‚˜',
        recipient: targetUser.name,
        content: `íŒŒì¼ì„ ê³µìœ í•©ë‹ˆë‹¤: ${file}`,
        timestamp: new Date(),
        type: 'file-share',
        file: file
      };
      setMessages(prev => [...prev, shareMessage]);
      setMessengerExpanded(true);
      setUserProfilePopup({ show: false, user: null, x: 0, y: 0 });
    }
  };

  // AI ë¶„ì„ ê¸°ëŠ¥
  const handleAIAnalysis = async (file, type) => {
    setLoading(true);
    try {
      let analysisType = type === 'ìš”ì•½' ? 'summary' : 'analysis';
      
      // ìƒˆë¡œìš´ AI ë¶„ì„ API ì‚¬ìš©
      const result = await analyzeFilesAI([file], analysisType, {
        currentPath: currentPath,
        selectedFiles: selectedFiles
      });
      
      if (result.success) {
        setAiResult({
          type: analysisType,
          file: file.name,
          content: result.analysis || `${file.name} íŒŒì¼ì— ëŒ€í•œ AI ${type} ê²°ê³¼ìž…ë‹ˆë‹¤.`,
          timestamp: new Date(),
          usage: result.usage
        });
      } else {
        // í´ë°±: ê¸°ì¡´ API ì‚¬ìš©
        const fallbackResult = await getAISummary(`ì´ íŒŒì¼ì„ ${type}í•´ì£¼ì„¸ìš”: ${file.name}`);
        setAiResult({
          type: analysisType,
          file: file.name,
          content: fallbackResult || `${file.name} íŒŒì¼ì— ëŒ€í•œ AI ${type} ê²°ê³¼ìž…ë‹ˆë‹¤.`,
          timestamp: new Date()
        });
      }
      
      setAiChatExpanded(true);
    } catch (error) {
      console.error(`AI ${type} ì‹¤íŒ¨:`, error);
      setAiResult({
        type: 'error',
        content: `AI ${type} ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${error.message}`,
        timestamp: new Date()
      });
    } finally {
      setLoading(false);
    }
    setContextMenu({ show: false, x: 0, y: 0, target: null });
  };

  /**
   * ì„ íƒëœ íŒŒì¼ë“¤ì— ëŒ€í•œ AI ë¶„ì„
   */
  const handleSelectedFilesAnalysis = async (analysisType = 'summary') => {
    if (selectedFiles.length === 0) {
      setAiResult({
        type: 'error',
        content: 'ë¶„ì„í•  íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”.',
        timestamp: new Date()
      });
      return;
    }

    setLoading(true);
    try {
      const result = await analyzeFilesAI(selectedFiles, analysisType, {
        currentPath: currentPath,
        totalFiles: files.length
      });
      
      if (result.success) {
        setAiResult({
          type: analysisType,
          files: selectedFiles.map(f => f.name),
          content: result.analysis,
          timestamp: new Date(),
          usage: result.usage
        });
      } else {
        setAiResult({
          type: 'error',
          content: 'AI ë¶„ì„ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.',
          timestamp: new Date()
        });
      }
      
      setAiChatExpanded(true);
    } catch (error) {
      console.error('ì„ íƒ íŒŒì¼ AI ë¶„ì„ ì‹¤íŒ¨:', error);
      setAiResult({
        type: 'error',
        content: `AI ë¶„ì„ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${error.message}`,
        timestamp: new Date()
      });
    } finally {
      setLoading(false);
    }
  };

  /**
   * ê²€ìƒ‰ ê²°ê³¼ AI ë¶„ì„
   */
  const handleSearchResultsAnalysis = async (searchResults, query) => {
    if (!searchResults || searchResults.length === 0) {
      setAiResult({
        type: 'error',
        content: 'ë¶„ì„í•  ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.',
        timestamp: new Date()
      });
      return;
    }

    setLoading(true);
    try {
      const result = await analyzeSearchResultsAI(searchResults, query, {
        currentPath: currentPath,
        totalFiles: files.length
      });
      
      if (result.success) {
        setAiResult({
          type: 'search-analysis',
          query: query,
          content: result.analysis,
          timestamp: new Date(),
          usage: result.usage
        });
      } else {
        setAiResult({
          type: 'error',
          content: 'ê²€ìƒ‰ ê²°ê³¼ ë¶„ì„ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.',
          timestamp: new Date()
        });
      }
      
      setAiChatExpanded(true);
    } catch (error) {
      console.error('ê²€ìƒ‰ ê²°ê³¼ AI ë¶„ì„ ì‹¤íŒ¨:', error);
      setAiResult({
        type: 'error',
        content: `ê²€ìƒ‰ ê²°ê³¼ ë¶„ì„ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${error.message}`,
        timestamp: new Date()
      });
    } finally {
      setLoading(false);
    }
  };

  /**
   * íŒŒì¼ ì •ë¦¬ ì¶”ì²œ
   */
  const handleOrganizationRecommendation = async () => {
    if (files.length === 0) {
      setAiResult({
        type: 'error',
        content: 'ì •ë¦¬í•  íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤.',
        timestamp: new Date()
      });
      return;
    }

    setLoading(true);
    try {
      const result = await recommendOrganizationAI(files, currentPath, {
        preferences: {
          autoOrganize: true,
          keepOriginalStructure: false,
          createBackup: true
        }
      });
      
      if (result.success) {
        setAiResult({
          type: 'organization',
          content: result.recommendation,
          timestamp: new Date(),
          usage: result.usage
        });
      } else {
        setAiResult({
          type: 'error',
          content: 'íŒŒì¼ ì •ë¦¬ ì¶”ì²œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.',
          timestamp: new Date()
        });
      }
      
      setAiChatExpanded(true);
    } catch (error) {
      console.error('íŒŒì¼ ì •ë¦¬ ì¶”ì²œ ì‹¤íŒ¨:', error);
      setAiResult({
        type: 'error',
        content: `íŒŒì¼ ì •ë¦¬ ì¶”ì²œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${error.message}`,
        timestamp: new Date()
      });
    } finally {
      setLoading(false);
    }
  };

  // ì „ì—­ í´ë¦­ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
  useEffect(() => {
    const handleGlobalClick = () => {
      if (userProfilePopup.show) {
        setUserProfilePopup({ show: false, user: null, x: 0, y: 0 });
      }
    };
    
    document.addEventListener('click', handleGlobalClick);
    return () => document.removeEventListener('click', handleGlobalClick);
  }, [userProfilePopup.show]);

  const performAdvancedSearch = async (searchParams) => {
    try {
      const response = await apiFetch('/api/search/advanced', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(searchParams)
      });
      const results = response.results || [];
      setFiles(results);
      
      // ê²€ìƒ‰ ížˆìŠ¤í† ë¦¬ì— ì¶”ê°€
      setSearchHistory(prev => [...prev, { query: searchParams, timestamp: new Date() }]);
    } catch (error) {
      console.error('ê³ ê¸‰ ê²€ìƒ‰ ì‹¤íŒ¨:', error);
    }
  };

  const handleDriveClick = (drive) => {
    let path = drive.name;
    // ë“œë¼ì´ë¸Œ ë£¨íŠ¸(C:, D: ë“±)ì¼ ê²½ìš° ë°˜ë“œì‹œ C:\ í˜•íƒœë¡œ ë³´ì •
    if (/^[A-Z]:$/i.test(path)) {
      path = path + '\\';
    }
    setCurrentPath(path);
    loadFiles(path);
    updateBreadcrumbs(path);
  };

  const handleBreadcrumbClick = (path) => {
    setCurrentPath(path);
    loadFiles(path);
    updateBreadcrumbs(path);
  };

  const loadFiles = async (dirPath) => {
    setLoading(true);
    try {
      const result = await electronAPI.listFiles(dirPath);
      if (result.error) {
        setFiles([]);
        setAiResult({ type: 'error', content: result.error });
        setLoading(false);
        return;
      }
      const list = result.files || result;
      const sortedFiles = sortFiles(list, sortBy, sortOrder);
      setFiles(sortedFiles);
      setPreview(null);
      setAiResult(null);
      setSelectedFiles([]);
    } catch (e) {
      setAiResult({ type: 'error', content: 'íŒŒì¼ ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨: ' + e.message });
    }
    setLoading(false);
  };

  const sortFiles = (files, sortBy, sortOrder) => {
    return [...files].sort((a, b) => {
      let comparison = 0;
      
      switch (sortBy) {
        case 'name':
          comparison = a.name.localeCompare(b.name);
          break;
        case 'size':
          comparison = (a.size || 0) - (b.size || 0);
          break;
        case 'modified':
          comparison = new Date(a.modified || 0) - new Date(b.modified || 0);
          break;
        case 'type':
          const aExt = a.name.split('.').pop() || '';
          const bExt = b.name.split('.').pop() || '';
          comparison = aExt.localeCompare(bExt);
          break;
        default:
          comparison = 0;
      }
      
      return sortOrder === 'asc' ? comparison : -comparison;
    });
  };

  const handleFileClick = async (file) => {
    if (file.isDirectory) {
      setCurrentPath(file.path);
      loadFiles(file.path);
      updateBreadcrumbs(file.path);
      return;
    }
    
    // í˜„ìž¬ ì‚¬ìš©ìž í™œë™ ì—…ë°ì´íŠ¸
    setCurrentUserActivity({
      viewingFile: file.name,
      lastAction: 'íŒŒì¼ ì—´ëžŒ ì¤‘',
      timestamp: new Date()
    });
    
    // ì‹¤ì‹œê°„ í™œë™ ë¸Œë¡œë“œìºìŠ¤íŠ¸
    broadcastUserActivity({
      fileName: file.name,
      filePath: file.path,
      action: 'íŒŒì¼ ì—´ëžŒ ì¤‘',
      timestamp: new Date()
    });
    
    try {
      // íŒŒì¼ ë¯¸ë¦¬ë³´ê¸° ê°œì„ 
      const res = await electronAPI.readFile(file.path);
      const fileExt = file.name.split('.').pop()?.toLowerCase();
      
      let previewContent = res.content;
      let previewType = 'text';
      
      // íŒŒì¼ íƒ€ìž…ë³„ ë¯¸ë¦¬ë³´ê¸° ì²˜ë¦¬
      if (['jpg', 'jpeg', 'png', 'gif', 'bmp', 'svg', 'webp'].includes(fileExt)) {
        previewType = 'image';
        previewContent = file.path; // ì´ë¯¸ì§€ ê²½ë¡œ
      } else if (['mp4', 'avi', 'mov', 'mkv', 'wmv'].includes(fileExt)) {
        previewType = 'video';
        previewContent = file.path;
      } else if (['mp3', 'wav', 'flac', 'aac', 'ogg'].includes(fileExt)) {
        previewType = 'audio';
        previewContent = file.path;
      } else if (['pdf'].includes(fileExt)) {
        previewType = 'pdf';
        previewContent = res.content.slice(0, 1000); // PDF í…ìŠ¤íŠ¸ ì¼ë¶€
      } else {
        previewType = 'text';
        previewContent = res.content.slice(0, 5000); // í…ìŠ¤íŠ¸ íŒŒì¼
      }
      
      setPreview({ 
        ...file, 
        content: previewContent, 
        type: previewType,
        fullPath: file.path
      });
      setAiResult(null);
    } catch (e) {
      console.error('íŒŒì¼ ì½ê¸° ì‹¤íŒ¨:', e);
      setPreview({ 
        ...file, 
        content: 'íŒŒì¼ì„ ì½ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.', 
        type: 'error',
        fullPath: file.path
      });
    }
  };

  const handleFileSelect = (file, event) => {
    if (event.ctrlKey || event.metaKey) {
      setSelectedFiles(prev => 
        prev.find(f => f.path === file.path)
          ? prev.filter(f => f.path !== file.path)
          : [...prev, file]
      );
    } else {
      setSelectedFiles([file]);
    }
  };

  const handleFileDoubleClick = (file) => {
    if (file.isDirectory) {
      handleFileClick(file);
    } else {
      // íŒŒì¼ ì—´ê¸° (ì‹œìŠ¤í…œ ê¸°ë³¸ í”„ë¡œê·¸ëž¨ìœ¼ë¡œ)
      openFileWithDefaultProgram(file);
    }
  };

  // ì‹œìŠ¤í…œ ê¸°ë³¸ í”„ë¡œê·¸ëž¨ìœ¼ë¡œ íŒŒì¼ ì—´ê¸°
  const openFileWithDefaultProgram = async (file) => {
    try {
      // Electron APIë¥¼ ì‚¬ìš©í•˜ì—¬ íŒŒì¼ ì‹¤í–‰
      if (electronAPI && electronAPI.openFile) {
        await electronAPI.openFile(file.path);
      } else if (electronAPI && electronAPI.shell) {
        // shell.openPathë¥¼ ì‚¬ìš©í•˜ì—¬ íŒŒì¼ ì‹¤í–‰
        await electronAPI.shell.openPath(file.path);
      } else {
        // ì›¹ í™˜ê²½ì—ì„œëŠ” window.open ì‚¬ìš©
        window.open(file.path, '_blank');
      }
      
      // ì‚¬ìš©ìž í™œë™ ì—…ë°ì´íŠ¸
      setCurrentUserActivity({
        viewingFile: file.name,
        lastAction: 'íŒŒì¼ ì‹¤í–‰',
        timestamp: new Date()
      });
      
      broadcastUserActivity({
        fileName: file.name,
        action: 'íŒŒì¼ ì‹¤í–‰',
        timestamp: new Date()
      });
    } catch (error) {
      console.error('íŒŒì¼ ì‹¤í–‰ ì‹¤íŒ¨:', error);
      // ëŒ€ì²´ ë°©ë²•: ë¯¸ë¦¬ë³´ê¸°ë¡œ ì „í™˜
      handleFileClick(file);
    }
  };

  const handleContextMenu = (event, file) => {
    event.preventDefault();
    setContextMenu({
      show: true,
      x: window.innerWidth - 320, // ìš°ì¸¡ì— ê³ ì • ìœ„ì¹˜
      y: Math.min(event.clientY, window.innerHeight - 400), // í™”ë©´ ë°–ìœ¼ë¡œ ë‚˜ê°€ì§€ ì•Šê²Œ
      target: file
    });
  };

  const handleDragOver = (e) => {
    e.preventDefault();
    setDragOver(true);
  };

  const handleDragLeave = (e) => {
    e.preventDefault();
    setDragOver(false);
  };

  const handleDrop = async (e) => {
    e.preventDefault();
    setDragOver(false);
    
    const files = Array.from(e.dataTransfer.files);
    console.log('ë“œë¡­ëœ íŒŒì¼ë“¤:', files);
  };

  const handleSendChat = async () => {
    if (!chatInput.trim()) return;
    setChatHistory(prev => [...prev, { role: 'user', content: chatInput }]);
    const userInput = chatInput;
    setChatInput('');
    setAiThinking(true);
    try {
      // ì‹œìŠ¤í…œ í´ë”ëª… í•œê¸€/ì˜ë¬¸ ë§¤í•‘ (ì‹¤ì œ ì‚¬ìš©ìž í”„ë¡œí•„ ê²½ë¡œ í™œìš©)
      const getUserProfile = () => {
        try {
          return require('os').homedir();
        } catch (e) {
          return process.env.USERPROFILE || process.env.HOME || 'C:\\Users\\Public';
        }
      };
      
      const userProfile = getUserProfile();
      const systemFolderMap = {
        'ë°”íƒ•í™”ë©´': `${userProfile}\\Desktop`,
        'ë¬¸ì„œ': `${userProfile}\\Documents`,
        'ë‹¤ìš´ë¡œë“œ': `${userProfile}\\Downloads`,
        'ì‚¬ì§„': `${userProfile}\\Pictures`,
        'ìŒì•…': `${userProfile}\\Music`,
        'ë™ì˜ìƒ': `${userProfile}\\Videos`,
        'desktop': `${userProfile}\\Desktop`,
        'documents': `${userProfile}\\Documents`,
        'downloads': `${userProfile}\\Downloads`,
        'pictures': `${userProfile}\\Pictures`,
        'music': `${userProfile}\\Music`,
        'videos': `${userProfile}\\Videos`,
        // ëŒ€ì²´ ê²½ë¡œë“¤
        'download': `${userProfile}\\Downloads`,
        'ë‹¤ìš´': `${userProfile}\\Downloads`,
        'picture': `${userProfile}\\Pictures`,
        'photo': `${userProfile}\\Pictures`,
        'image': `${userProfile}\\Pictures`,
      };
      // ìžì—°ì–´ì—ì„œ í´ë” ê²½ë¡œ ì¶”ì¶œ í•¨ìˆ˜
      function extractTargetDirectory(query) {
        for (const [keyword, path] of Object.entries(systemFolderMap)) {
          if (query.toLowerCase().includes(keyword.toLowerCase())) {
            return path;
          }
        }
        const pathRegex = /([A-Z]:[\\/][^\s"']*)/i;
        const match = query.match(pathRegex);
        if (match) return match[1].replace(/\//g, '\\');
        return null;
      }
      let plan = await getAIPlan(userInput);
      if (typeof plan === 'string' && plan.trim().startsWith('{')) {
        plan = JSON.parse(plan);
      }
      if (!plan || !plan.action) {
        throw new Error('AI í”Œëžœì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.');
      }
      let action = plan.action || '';
      // targetDirectory ì¶”ì¶œì„ tryë¬¸ ì•ˆì—ì„œ ì‹¤í–‰ (ìš°ì„ ìˆœìœ„: ìžì—°ì–´ ì¶”ì¶œ > í˜„ìž¬ ê²½ë¡œ > AI í”Œëžœ)
      let targetDirectory = extractTargetDirectory(userInput) || currentPath || plan.targetDirectory || 'C:\\';
      
      // ë””ë²„ê¹… ì •ë³´ ì¶œë ¥
      console.log('ì‚¬ìš©ìž ìž…ë ¥:', userInput);
      console.log('ì¶”ì¶œëœ ê²½ë¡œ:', extractTargetDirectory(userInput));
      console.log('í˜„ìž¬ ê²½ë¡œ:', currentPath);
      console.log('AI í”Œëžœ ê²½ë¡œ:', plan.targetDirectory);
      console.log('ìµœì¢… ëŒ€ìƒ ê²½ë¡œ:', targetDirectory);
      // ë¬´ì œí•œ ê¹Šì´ ìž¬ê·€ íƒìƒ‰ (ê¸°ì¡´ ìž‘ë™í•˜ë˜ ë¡œì§ ê°œì„ )
      async function getAllFilesRecursive(dir, depth = 0, maxDepth = Infinity) {
        if (depth > maxDepth) return [];
        let allFiles = [];
        try {
          console.log(`íƒìƒ‰ ì¤‘: ${dir} (ê¹Šì´: ${depth})`);
          const result = await electronAPI.listFiles(dir);
          const list = result.files || result || [];
          
          console.log(`${dir}ì—ì„œ ${list.length}ê°œ í•­ëª© ë°œê²¬`);
          
          for (const f of list) {
            if (f.isDirectory) {
              try {
                // ìž¬ê·€ì ìœ¼ë¡œ í•˜ìœ„ ë””ë ‰í† ë¦¬ íƒìƒ‰ (ë¬´ì œí•œ ê¹Šì´)
                const subFiles = await getAllFilesRecursive(f.path, depth + 1, maxDepth);
                allFiles = allFiles.concat(subFiles);
              } catch (subError) {
                console.warn(`í•˜ìœ„ í´ë” íƒìƒ‰ ì‹¤íŒ¨: ${f.path}`, subError.message);
              }
            } else {
              allFiles.push(f);
            }
          }
        } catch (e) {
          console.error(`í´ë” ì ‘ê·¼ ì‹¤íŒ¨: ${dir}`, e.message);
        }
        return allFiles;
      }
      let resultMsg = '';
      let actionPerformed = false;
      if (action === 'searchFiles' || action === 'listFiles') {
        try {
          // ìžì—°ì–´ì—ì„œ í™•ìž¥ìžì™€ ê²€ìƒ‰ íŒ¨í„´ ì¶”ì¶œ
          const extractedExtensions = extractExtensionsFromQuery(userInput);
          const planFilters = plan.filters || [];
          const searchPattern = plan.searchTerm || '';
          const advFilters = extractAdvancedFilters(userInput);
          
          // ì´ë¯¸ì§€ íŒŒì¼ í™•ìž¥ìž ë³´ê°• (AIê°€ ë†“ì¹  ìˆ˜ ìžˆëŠ” í™•ìž¥ìžë“¤ ì¶”ê°€)
          const allImageExtensions = ['jpg', 'jpeg', 'png', 'gif', 'bmp', 'svg', 'webp', 'tiff', 'tif', 'ico', 'psd', 'ai', 'eps', 'raw', 'cr2', 'nef', 'dng', 'heic', 'heif'];
          
          // 1. "ëª¨ë“  íŒŒì¼" ë“± ëª…ë ¹ì´ê±°ë‚˜, í•„í„°ê°€ ì—†ìœ¼ë©´ ì „ì²´ íŒŒì¼ ë°˜í™˜
          const isAllFilesQuery = /ëª¨ë“  íŒŒì¼|ì „ì²´|ìƒê´€ì—†ì´|all files|any file|ì „ë¶€|ë‹¤ ë³´ì—¬ì¤˜/.test(userInput);
          
          // 2. êµ¬ì²´ì ì¸ í™•ìž¥ìž ìš”ì²­ì¸ì§€ í™•ì¸
          const hasSpecificExtension = /\.([a-z0-9]{2,5})/i.test(userInput);
          const hasSpecificFileType = /pdf|PDF|ì—‘ì…€|ì›Œë“œ|íŒŒì›Œí¬ì¸íŠ¸|í…ìŠ¤íŠ¸|ì´ë¯¸ì§€|ì‚¬ì§„|ë™ì˜ìƒ|ìŒì•…|ì••ì¶•|ì½”ë“œ|ì‹¤í–‰íŒŒì¼/.test(userInput);
          
          let fileTypeFilters = [...extractedExtensions, ...planFilters];
          
          // ì´ë¯¸ì§€ ë“± í‚¤ì›Œë“œ ë³´ê°•ì€ ê¸°ì¡´ëŒ€ë¡œ ìœ ì§€ (êµ¬ì²´ì ì¸ ìš”ì²­ì´ ì—†ì„ ë•Œë§Œ)
          if (!hasSpecificExtension && !hasSpecificFileType && (userInput.includes('ì´ë¯¸ì§€') || userInput.includes('ì‚¬ì§„') || userInput.includes('image') || userInput.includes('photo'))) {
            fileTypeFilters = [...fileTypeFilters, ...allImageExtensions];
          }
          
          fileTypeFilters = [...new Set(fileTypeFilters)];
          
          console.log(`ðŸ” ê²€ìƒ‰ ë¶„ì„:`, {
            userInput,
            extractedExtensions,
            planFilters,
            fileTypeFilters,
            hasSpecificExtension,
            hasSpecificFileType,
            isAllFilesQuery
          });
          
          let files = await getAllFilesRecursive(targetDirectory, 0, Infinity);
          
          // 3. í•„í„° ì ìš© (ì •í™•í•œ í™•ìž¥ìž ë§¤ì¹­)
          if (!isAllFilesQuery && fileTypeFilters.length > 0) {
            const beforeFilter = files.length;
            console.log(`ðŸ“‹ ì ìš©í•  í•„í„°ë“¤: ${fileTypeFilters.join(', ')}`);
            
            files = files.filter(f => {
              const fileName = f.name.toLowerCase();
              const fileExt = fileName.split('.').pop() || '';
              
              const matches = fileTypeFilters.some(filter => {
                const filterLower = filter.toLowerCase();
                return fileExt === filterLower;
              });
              
              if (matches) {
                console.log(`âœ… ë§¤ì¹˜: ${f.name} (í™•ìž¥ìž: ${fileExt})`);
              }
              
              return matches;
            });
            
            console.log(`ðŸŽ¯ í•„í„°ë§ ì™„ë£Œ: ${beforeFilter}ê°œ â†’ ${files.length}ê°œ íŒŒì¼`);
          }
          
          // 4. ê²°ê³¼ê°€ 0ê°œë©´ ì „ì²´ íŒŒì¼ fallback ì•ˆë‚´
          if (files.length === 0 && !isAllFilesQuery) {
            const allFiles = await getAllFilesRecursive(targetDirectory, 0, Infinity);
            resultMsg = `í•„í„°ì— ë§žëŠ” íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤. ëŒ€ì‹  ì „ì²´ íŒŒì¼ ${allFiles.length}ê°œë¥¼ ë³´ì—¬ë“œë¦´ê²Œìš”!`;
            setFiles(allFiles);
            actionPerformed = true;
          } else if (files.length > 0) {
            // 5. íŒŒì¼ íƒ€ìž…ë³„ ì ì ˆí•œ ì´ëª¨ì§€ì™€ ë©”ì‹œì§€ ìƒì„±
            let emoji = 'ðŸ“„';
            let fileType = 'íŒŒì¼';
            
            if (hasSpecificExtension || hasSpecificFileType) {
              if (userInput.toLowerCase().includes('pdf')) {
                emoji = 'ðŸ“•';
                fileType = 'PDF íŒŒì¼';
              } else if (userInput.includes('ì—‘ì…€') || userInput.includes('xls') || userInput.includes('xlsx')) {
                emoji = 'ðŸ“Š';
                fileType = 'ì—‘ì…€ íŒŒì¼';
              } else if (userInput.includes('ì›Œë“œ') || userInput.includes('doc') || userInput.includes('docx')) {
                emoji = 'ðŸ“';
                fileType = 'ì›Œë“œ íŒŒì¼';
              } else if (userInput.includes('íŒŒì›Œí¬ì¸íŠ¸') || userInput.includes('ppt') || userInput.includes('pptx')) {
                emoji = 'ðŸ“½ï¸';
                fileType = 'íŒŒì›Œí¬ì¸íŠ¸ íŒŒì¼';
              } else if (userInput.includes('í…ìŠ¤íŠ¸') || userInput.includes('txt')) {
                emoji = 'ðŸ“„';
                fileType = 'í…ìŠ¤íŠ¸ íŒŒì¼';
              } else if (userInput.includes('ì´ë¯¸ì§€') || userInput.includes('ì‚¬ì§„') || userInput.includes('image') || userInput.includes('photo')) {
                emoji = 'ðŸ–¼ï¸';
                fileType = 'ì´ë¯¸ì§€ íŒŒì¼';
              } else if (userInput.includes('ë™ì˜ìƒ') || userInput.includes('video')) {
                emoji = 'ðŸŽ¬';
                fileType = 'ë™ì˜ìƒ íŒŒì¼';
              } else if (userInput.includes('ìŒì•…') || userInput.includes('music')) {
                emoji = 'ðŸŽµ';
                fileType = 'ìŒì•… íŒŒì¼';
              } else if (userInput.includes('ì••ì¶•')) {
                emoji = 'ðŸ“¦';
                fileType = 'ì••ì¶• íŒŒì¼';
              } else if (userInput.includes('ì½”ë“œ')) {
                emoji = 'ðŸ’»';
                fileType = 'ì½”ë“œ íŒŒì¼';
              } else if (userInput.includes('ì‹¤í–‰íŒŒì¼')) {
                emoji = 'âš™ï¸';
                fileType = 'ì‹¤í–‰ íŒŒì¼';
              }
            }
            
            resultMsg = `âœ… ${targetDirectory}ì—ì„œ ${files.length}ê°œì˜ ${fileType}ì„ ì°¾ì•˜ìŠµë‹ˆë‹¤!\n\n` +
                       files.slice(0, 10).map(f => `${emoji} ${f.name} (${((f.size || 0) / 1024 / 1024).toFixed(1)}MB)`).join('\n') +
                       (files.length > 10 ? `\n\n... ê·¸ ì™¸ ${files.length - 10}ê°œ ë” ìžˆìŠµë‹ˆë‹¤.` : '');
            setFiles(files);
            actionPerformed = true;
          } else {
            resultMsg = `âŒ ${targetDirectory} í´ë”ì™€ ëª¨ë“  í•˜ìœ„ í´ë”ë¥¼ ê²€ìƒ‰í–ˆì§€ë§Œ ì¡°ê±´ì— ë§žëŠ” íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`;
            setFiles([]);
            actionPerformed = true;
          }
        } catch (e) {
          resultMsg = 'í´ë” ì ‘ê·¼ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.';
        }
      }
      setChatHistory(prev => [...prev, { role: 'ai', content: resultMsg }]);
      if (actionPerformed && resultMsg) {
        const aiSummary = await getAISummary(resultMsg);
        if (aiSummary) {
          setChatHistory(prev => [...prev, { role: 'ai', content: aiSummary }]);
        }
      }
    } catch (e) {
      setChatHistory(prev => [...prev, { role: 'ai', content: `ì£„ì†¡í•©ë‹ˆë‹¤. ëª…ë ¹ì„ ì²˜ë¦¬í•˜ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${e.message}` }]);
    } finally {
      setAiThinking(false);
    }
  };

  // ë©”ì‹ ì € ë©”ì‹œì§€ ì „ì†¡
  const handleSendMessage = () => {
    if (!messengerInput.trim()) return;
    
    const newMessage = {
      id: Date.now(),
      sender: 'ë‚˜',
      content: messengerInput,
      timestamp: new Date(),
      type: 'text'
    };
    
    setMessages(prev => [...prev, newMessage]);
    setMessengerInput('');
    
    // ì‹œë®¬ë ˆì´ì…˜: ë‹¤ë¥¸ ì‚¬ìš©ìžì˜ ì‘ë‹µ
    setTimeout(() => {
      const responses = [
        'ë„¤, í™•ì¸í–ˆìŠµë‹ˆë‹¤!',
        'íŒŒì¼ ë°›ì•˜ìŠµë‹ˆë‹¤. ê°ì‚¬í•©ë‹ˆë‹¤.',
        'ì¢‹ì€ ì•„ì´ë””ì–´ë„¤ìš”!',
        'ì§€ê¸ˆ ê²€í†  ì¤‘ìž…ë‹ˆë‹¤.',
        'ê³§ í”¼ë“œë°± ë“œë¦¬ê² ìŠµë‹ˆë‹¤.'
      ];
      
      const randomUser = onlineUsers[Math.floor(Math.random() * onlineUsers.length)];
      const randomResponse = responses[Math.floor(Math.random() * responses.length)];
      
      const responseMessage = {
        id: Date.now() + 1,
        sender: randomUser.name,
        content: randomResponse,
        timestamp: new Date(),
        type: 'text',
        avatar: randomUser.avatar
      };
      
      setMessages(prev => [...prev, responseMessage]);
    }, 1000 + Math.random() * 3000);
  };

  const handleContextMenuAction = (action) => {
    if (!contextMenu.target) return;
    
    switch (action) {
      case 'preview':
        handleFileClick(contextMenu.target);
        break;
      case 'edit':
        console.log('íŽ¸ì§‘:', contextMenu.target);
        break;
      case 'copy':
        console.log('ë³µì‚¬:', contextMenu.target);
        break;
      case 'delete':
        console.log('ì‚­ì œ:', contextMenu.target);
        break;
      case 'share':
        // ë©”ì‹ ì €ë¡œ íŒŒì¼ ê³µìœ 
        const shareMessage = {
          id: Date.now(),
          sender: 'ë‚˜',
          content: `íŒŒì¼ì„ ê³µìœ í•©ë‹ˆë‹¤: ${contextMenu.target.name}`,
          timestamp: new Date(),
          type: 'file',
          file: contextMenu.target
        };
        setMessages(prev => [...prev, shareMessage]);
        setMessengerExpanded(true);
        break;
      case 'ai-summary':
        // AI ìš”ì•½ ê¸°ëŠ¥
        handleAIAnalysis(contextMenu.target, 'ìš”ì•½');
        break;
      case 'ai-analysis':
        // AI ë¶„ì„ ê¸°ëŠ¥
        handleAIAnalysis(contextMenu.target, 'ë¶„ì„');
        break;
    }
    setContextMenu({ show: false, x: 0, y: 0, target: null });
  };

  useEffect(() => {
    const handleGlobalClick = () => {
      if (contextMenu.show) {
        setContextMenu({ show: false, x: 0, y: 0, target: null });
      }
    };

    document.addEventListener('click', handleGlobalClick);
    return () => document.removeEventListener('click', handleGlobalClick);
  }, [contextMenu.show]);

  // íŒŒì¼ ì•„ì´ì½˜ ë§¤í•‘ í•¨ìˆ˜ (SVG fallback)
  // ìœˆë„ìš°/ë§¥/ë¦¬ëˆ…ìŠ¤ ë„¤ì´í‹°ë¸Œ ì•„ì´ì½˜ì€ getFileThumbnailì—ì„œ ìš°ì„  ì ìš©
  const getFileIcon = (file) => {
    if (file.isDirectory) return FolderIcon;
    
    const ext = file.name.split('.').pop()?.toLowerCase();
    const iconMap = {
      'jpg': PhotoIcon, 'jpeg': PhotoIcon, 'png': PhotoIcon, 'gif': PhotoIcon, 'bmp': PhotoIcon, 'svg': PhotoIcon, 'webp': PhotoIcon,
      'mp4': VideoCameraIcon, 'avi': VideoCameraIcon, 'mov': VideoCameraIcon, 'wmv': VideoCameraIcon, 'mkv': VideoCameraIcon,
      'mp3': MusicalNoteIcon, 'wav': MusicalNoteIcon, 'flac': MusicalNoteIcon, 'aac': MusicalNoteIcon, 'ogg': MusicalNoteIcon,
      'pdf': DocumentIcon, 'doc': DocumentIcon, 'docx': DocumentIcon, 'txt': DocumentTextIcon, 'rtf': DocumentIcon,
      'js': CodeBracketIcon, 'jsx': CodeBracketIcon, 'ts': CodeBracketIcon, 'tsx': CodeBracketIcon, 'py': CodeBracketIcon,
      'zip': ArchiveBoxIcon, 'rar': ArchiveBoxIcon, '7z': ArchiveBoxIcon, 'tar': ArchiveBoxIcon, 'gz': ArchiveBoxIcon
    };
    
    return iconMap[ext] || DocumentIcon;
  };

  // ì‹œìŠ¤í…œ ì•„ì´ì½˜ ë¡œë“œ í•¨ìˆ˜ (ìœˆë„ìš°/ë§¥/ë¦¬ëˆ…ìŠ¤ ë„¤ì´í‹°ë¸Œ ì•„ì´ì½˜ ì§€ì›)
  const loadSystemIcon = async (file) => {
    if (file.isDirectory || fileIcons[file.path]) {
      return; // í´ë”ì´ê±°ë‚˜ ì´ë¯¸ ë¡œë“œëœ ê²½ìš° ìŠ¤í‚µ
    }
    try {
      // electronAPI.getFileIconì„ í†µí•´ base64 ì•„ì´ì½˜ ìš”ì²­
      const iconData = await electronAPI.getFileIcon(file.path);
      if (iconData) {
        setFileIcons(prev => ({
          ...prev,
          [file.path]: iconData
        }));
      }
    } catch (error) {
      // ì•„ì´ì½˜ ë¡œë“œ ì‹¤íŒ¨ ì‹œ ë¬´ì‹œ
    }
  };

  // íŒŒì¼ ì¸ë„¤ì¼ ìƒì„± í•¨ìˆ˜ (ì‹œìŠ¤í…œ ì•„ì´ì½˜ ìš°ì„  ì‚¬ìš©)
  // 1. fileIcons[file.path]ì— base64 ì•„ì´ì½˜ì´ ìžˆìœ¼ë©´ ìš°ì„  í‘œì‹œ
  // 2. ì—†ìœ¼ë©´ electronAPI.getFileIconìœ¼ë¡œ ë¹„ë™ê¸° ë¡œë“œ ì‹œë„
  // 3. ê·¸ëž˜ë„ ì—†ìœ¼ë©´ í™•ìž¥ìžë³„ SVG fallback
  const getFileThumbnail = (file) => {
    // ì‹œìŠ¤í…œ ì•„ì´ì½˜ì´ ìžˆìœ¼ë©´ ì‚¬ìš©
    if (fileIcons[file.path]) {
      return (
        <div className="w-12 h-12 rounded-xl overflow-hidden bg-white dark:bg-gray-800 flex items-center justify-center p-1">
          <img 
            src={fileIcons[file.path]} 
            alt={file.name}
            className="w-full h-full object-contain"
          />
        </div>
      );
    }

    // ì‹œìŠ¤í…œ ì•„ì´ì½˜ì´ ì—†ìœ¼ë©´ ë¹„ë™ê¸°ë¡œ ë¡œë“œ ì‹œë„
    if (!file.isDirectory && electronAPI.isElectronApp()) {
      setTimeout(() => loadSystemIcon(file), 10);
    }

    const ext = file.name.split('.').pop()?.toLowerCase();
    const imageExts = ['jpg', 'jpeg', 'png', 'gif', 'bmp', 'svg', 'webp'];
    const videoExts = ['mp4', 'avi', 'mov', 'mkv', 'wmv', 'flv', 'webm'];
    const audioExts = ['mp3', 'wav', 'flac', 'aac', 'ogg', 'wma'];
    const codeExts = ['js', 'jsx', 'ts', 'tsx', 'py', 'java', 'cpp', 'c', 'html', 'css', 'php', 'rb', 'go', 'rs'];
    const docExts = ['pdf', 'doc', 'docx', 'txt', 'rtf', 'odt'];
    const archiveExts = ['zip', 'rar', '7z', 'tar', 'gz', 'bz2'];
    
    if (imageExts.includes(ext)) {
      return (
        <div className="w-12 h-12 rounded-xl overflow-hidden bg-gray-100 dark:bg-gray-800 flex items-center justify-center">
          <img 
            src={`file://${file.path}`} 
            alt={file.name}
            className="w-full h-full object-cover"
            onError={(e) => {
              e.target.style.display = 'none';
              e.target.nextSibling.style.display = 'flex';
            }}
          />
          <div style={{display: 'none'}} className="w-full h-full bg-gradient-to-br from-pink-100 to-rose-200 dark:from-pink-900 dark:to-rose-800 flex items-center justify-center">
            <PhotoIcon className="w-6 h-6 text-pink-600 dark:text-pink-400" />
          </div>
        </div>
      );
    } 
    
    if (videoExts.includes(ext)) {
      return (
        <div className="w-12 h-12 rounded-xl bg-gradient-to-br from-purple-100 to-violet-200 dark:from-purple-900 dark:to-violet-800 flex items-center justify-center relative group">
          <VideoCameraIcon className="w-6 h-6 text-purple-600 dark:text-purple-400" />
          <div className="absolute inset-0 bg-black/20 rounded-xl flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity">
            <div className="w-3 h-3 bg-white rounded-full flex items-center justify-center">
              <div className="w-0 h-0 border-l-2 border-l-black border-y-1 border-y-transparent ml-0.5"></div>
            </div>
          </div>
        </div>
      );
    }
    
    if (audioExts.includes(ext)) {
      return (
        <div className="w-12 h-12 rounded-xl bg-gradient-to-br from-green-100 to-emerald-200 dark:from-green-900 dark:to-emerald-800 flex items-center justify-center relative group">
          <MusicalNoteIcon className="w-6 h-6 text-green-600 dark:text-green-400" />
          <div className="absolute inset-0 bg-black/10 rounded-xl flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity">
            <div className="flex space-x-0.5">
              <div className="w-0.5 h-2 bg-white rounded-full animate-pulse"></div>
              <div className="w-0.5 h-3 bg-white rounded-full animate-pulse" style={{animationDelay: '0.1s'}}></div>
              <div className="w-0.5 h-4 bg-white rounded-full animate-pulse" style={{animationDelay: '0.2s'}}></div>
              <div className="w-0.5 h-3 bg-white rounded-full animate-pulse" style={{animationDelay: '0.3s'}}></div>
              <div className="w-0.5 h-2 bg-white rounded-full animate-pulse" style={{animationDelay: '0.4s'}}></div>
            </div>
          </div>
        </div>
      );
    }
    
    if (codeExts.includes(ext)) {
      return (
        <div className="w-12 h-12 rounded-xl bg-gradient-to-br from-orange-100 to-red-200 dark:from-orange-900 dark:to-red-800 flex items-center justify-center relative group">
          <CodeBracketIcon className="w-6 h-6 text-orange-600 dark:text-orange-400" />
          <div className="absolute top-1 right-1 text-[8px] font-bold text-orange-800 dark:text-orange-300 uppercase">
            {ext}
          </div>
        </div>
      );
    }
    
    if (docExts.includes(ext)) {
      return (
        <div className="w-12 h-12 rounded-xl bg-gradient-to-br from-blue-100 to-indigo-200 dark:from-blue-900 dark:to-indigo-800 flex items-center justify-center relative">
          <DocumentTextIcon className="w-6 h-6 text-blue-600 dark:text-blue-400" />
          <div className="absolute inset-2 border border-blue-300 dark:border-blue-600 rounded opacity-30"></div>
        </div>
      );
    }
    
    if (archiveExts.includes(ext)) {
      return (
        <div className="w-12 h-12 rounded-xl bg-gradient-to-br from-yellow-100 to-amber-200 dark:from-yellow-900 dark:to-amber-800 flex items-center justify-center relative">
          <ArchiveBoxIcon className="w-6 h-6 text-yellow-600 dark:text-yellow-400" />
          <div className="absolute top-1 right-1 w-2 h-2 bg-yellow-800 dark:bg-yellow-300 rounded-full"></div>
        </div>
      );
    }
    
    // ê¸°ë³¸ ì•„ì´ì½˜ í‘œì‹œ
    const Icon = getFileIcon(file);
    return (
      <div className={`w-12 h-12 rounded-xl flex items-center justify-center ${
        file.isDirectory 
          ? 'bg-gradient-to-br from-blue-100 to-blue-200 dark:from-blue-900 dark:to-blue-800' 
          : 'bg-gradient-to-br from-gray-100 to-gray-200 dark:from-gray-700 dark:to-gray-800'
      }`}>
        <Icon className={`w-6 h-6 ${
          file.isDirectory ? 'text-blue-600 dark:text-blue-400' : 'text-gray-600 dark:text-gray-400'
        }`} />
      </div>
    );
  };

  const formatFileSize = (bytes) => {
    if (!bytes) return '0 B';
    const k = 1024;
    const sizes = ['B', 'KB', 'MB', 'GB', 'TB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
  };

  const formatDate = (dateString) => {
    if (!dateString) return '';
    const date = new Date(dateString);
    return date.toLocaleDateString('ko-KR', {
      year: 'numeric',
      month: 'short',
      day: 'numeric',
      hour: '2-digit',
      minute: '2-digit'
    });
  };

  // í˜„ìž¬ í´ë”ì˜ íŒŒì¼ë“¤ì„ ê¸°ë°˜ìœ¼ë¡œ ê´€ë ¨ í•„í„°ë“¤ë§Œ í‘œì‹œ
  const getRelevantFilters = () => {
    const relevantFilters = [fileFilters[0]]; // 'all' í•„í„°ëŠ” í•­ìƒ í¬í•¨
    
    fileFilters.slice(1).forEach(filter => {
      // í•´ë‹¹ í•„í„°ì— ë§žëŠ” íŒŒì¼ì´ í•˜ë‚˜ë¼ë„ ìžˆìœ¼ë©´ í•„í„°ë¥¼ í‘œì‹œ
      const hasMatchingFiles = files.some(file => filter.filter(file));
      if (hasMatchingFiles) {
        relevantFilters.push(filter);
      }
    });
    
    return relevantFilters;
  };

  const relevantFilters = getRelevantFilters();

  // filteredFiles: OR ì¡°ê±´ìœ¼ë¡œ ì—¬ëŸ¬ í•„í„° ì¤‘ í•˜ë‚˜ë¼ë„ í†µê³¼í•˜ë©´ í‘œì‹œ
  const filteredFiles = files.filter(file => {
    const matchesSearch = file.name.toLowerCase().includes(searchQuery.toLowerCase());
    if (activeFilters.includes('all')) return matchesSearch;
    return activeFilters.some(filterId => {
      const filter = fileFilters.find(f => f.id === filterId);
      return filter ? filter.filter(file) : false;
    });
  });

  // 1. ì¹´í…Œê³ ë¦¬ â†’ í™•ìž¥ìž ë§¤í•‘ í…Œì´ë¸” ì¶”ê°€
  const categoryToExtensions = {
    'ì´ë¯¸ì§€': ['jpg','jpeg','png','gif','bmp','svg','webp','tiff','ico','psd','ai','raw','cr2','nef','dng'],
    'ì‚¬ì§„': ['jpg','jpeg','png','gif','bmp','webp','tiff','ico','raw'],
    'ë¬¸ì„œ': ['pdf','doc','docx','xls','xlsx','ppt','pptx','txt','rtf','odt','md','hwp'],
    'ë™ì˜ìƒ': ['mp4','avi','mov','mkv','wmv','flv','webm','m4v','3gp','ogv','mpg','mpeg'],
    'ìŒì•…': ['mp3','wav','flac','aac','ogg','wma','m4a','opus'],
    'ì••ì¶•': ['zip','rar','7z','tar','gz','bz2','xz','iso'],
    'ì½”ë“œ': ['js','jsx','ts','tsx','py','java','cpp','c','html','css','php','rb','go','rs','swift','kt','scala','sh','bat','ps1','sql','json','xml','yaml','yml','toml','ini','cfg','conf'],
    'ì‹¤í–‰íŒŒì¼': ['exe','msi','dmg','pkg','deb','rpm','app','apk','ipa','run','bin','com','scr','bat','cmd','ps1','vbs','jar','war'],
    'í°íŠ¸': ['ttf','otf','woff','woff2','eot','fon','pfb','pfm','afm'],
    'CAD': ['dwg','dxf','dwf','skp','step','stp','iges','igs','catpart','catproduct','prt','asm','ipt','iam','sldprt','sldasm','slddrw','3dm','rvt','rfa','rte','rft','fcstd','3ds','obj','fbx','max','blend'],
    'ë””ìžì¸': ['dwg','skp','3ds','max','blend','maya','c4d','fbx','obj','dae','stl','ply','x3d','fig','sketch','xd','indd','qxd','step','stp','iges','igs'],
    'ìŠ¤ì¼€ì¹˜ì—…': ['skp'],
    'ìŠ¤ì¼€ì¹˜ì—…íŒŒì¼': ['skp'],
    'sketchup': ['skp'],
    '3d': ['skp','stl','obj','fbx','3ds','max','blend','step','stp','iges','igs'],
  };

  // 2. ìžì—°ì–´ ëª…ë ¹ì—ì„œ í™•ìž¥ìž/í•„í„° ì¶”ì¶œ í•¨ìˆ˜ (ê°œì„ ëœ ë²„ì „)
  function extractExtensionsFromQuery(query) {
    let exts = [];
    let isSpecificExtension = false;
    
    // 1. ì§ì ‘ í™•ìž¥ìž ìž…ë ¥ í™•ì¸ (ê°€ìž¥ ìš°ì„ ìˆœìœ„)
    const extRegex = /\.([a-z0-9]{2,5})/gi;
    let match;
    while ((match = extRegex.exec(query)) !== null) {
      exts.push(match[1].toLowerCase());
      isSpecificExtension = true;
    }
    
    // 2. êµ¬ì²´ì ì¸ íŒŒì¼ íƒ€ìž… í‚¤ì›Œë“œ í™•ì¸
    const specificFileTypes = {
      'pdf': ['pdf'],
      'PDF': ['pdf'],
      'ì—‘ì…€': ['xls', 'xlsx'],
      'ì›Œë“œ': ['doc', 'docx'],
      'íŒŒì›Œí¬ì¸íŠ¸': ['ppt', 'pptx'],
      'í…ìŠ¤íŠ¸': ['txt'],
      'ì´ë¯¸ì§€': ['jpg', 'jpeg', 'png', 'gif', 'bmp', 'svg', 'webp', 'tiff', 'ico'],
      'ì‚¬ì§„': ['jpg', 'jpeg', 'png', 'gif', 'bmp', 'webp', 'tiff', 'ico'],
      'ë™ì˜ìƒ': ['mp4', 'avi', 'mov', 'mkv', 'wmv', 'flv', 'webm', 'm4v', '3gp', 'ogv', 'mpg', 'mpeg'],
      'ìŒì•…': ['mp3', 'wav', 'flac', 'aac', 'ogg', 'wma', 'm4a', 'opus'],
      'ì••ì¶•': ['zip', 'rar', '7z', 'tar', 'gz', 'bz2', 'xz', 'iso'],
      'ì½”ë“œ': ['js', 'jsx', 'ts', 'tsx', 'py', 'java', 'cpp', 'c', 'html', 'css', 'php', 'rb', 'go', 'rs', 'swift', 'kt', 'scala', 'sh', 'bat', 'ps1', 'sql', 'json', 'xml', 'yaml', 'yml', 'toml', 'ini', 'cfg', 'conf'],
      'ì‹¤í–‰íŒŒì¼': ['exe', 'msi', 'dmg', 'pkg', 'deb', 'rpm', 'app', 'apk', 'ipa', 'run', 'bin', 'com', 'scr', 'bat', 'cmd', 'ps1', 'vbs', 'jar', 'war'],
      'ìŠ¤ì¼€ì¹˜ì—…': ['skp'],
      'ìŠ¤ì¼€ì¹˜ì—…íŒŒì¼': ['skp'],
      'sketchup': ['skp'],
      '3d': ['skp','stl','obj','fbx','3ds','max','blend','step','stp','iges','igs'],
      'cad': ['dwg','dxf','dwf','skp','step','stp','iges','igs','catpart','catproduct','prt','asm','ipt','iam','sldprt','sldasm','slddrw','3dm','rvt','rfa','rte','rft','fcstd'],
    };
    
    // êµ¬ì²´ì ì¸ íŒŒì¼ íƒ€ìž… í‚¤ì›Œë“œ ê²€ìƒ‰
    for (const [keyword, extList] of Object.entries(specificFileTypes)) {
      if (query.includes(keyword)) {
        exts = [...exts, ...extList];
        isSpecificExtension = true;
        break; // ì²« ë²ˆì§¸ ë§¤ì¹˜ì—ì„œ ì¤‘ë‹¨ (ê°€ìž¥ êµ¬ì²´ì ì¸ ê²ƒë§Œ)
      }
    }
    
    // 3. ì¹´í…Œê³ ë¦¬ í‚¤ì›Œë“œ í™•ì¸ (êµ¬ì²´ì ì¸ í™•ìž¥ìžê°€ ì—†ì„ ë•Œë§Œ)
    if (!isSpecificExtension) {
      Object.entries(categoryToExtensions).forEach(([keyword, extList]) => {
        if (query.includes(keyword)) {
          exts = [...exts, ...extList];
        }
      });
    }
    
    return [...new Set(exts)];
  }

  // íŒŒì¼ íƒ€ìž… ë§¤ì¹­ ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ ì¶”ê°€
  function getFileTypeInfo(fileName, userQuery) {
    const ext = fileName.split('.').pop()?.toLowerCase() || '';
    const query = userQuery.toLowerCase();
    
    // êµ¬ì²´ì ì¸ íŒŒì¼ íƒ€ìž… ë§¤ì¹­
    if (query.includes('pdf') && ext === 'pdf') {
      return { type: 'PDF íŒŒì¼', emoji: 'ðŸ“•', priority: 1 };
    }
    if ((query.includes('ì—‘ì…€') || query.includes('xls') || query.includes('xlsx')) && ['xls', 'xlsx'].includes(ext)) {
      return { type: 'ì—‘ì…€ íŒŒì¼', emoji: 'ðŸ“Š', priority: 1 };
    }
    if ((query.includes('ì›Œë“œ') || query.includes('doc') || query.includes('docx')) && ['doc', 'docx'].includes(ext)) {
      return { type: 'ì›Œë“œ íŒŒì¼', emoji: 'ðŸ“', priority: 1 };
    }
    if ((query.includes('íŒŒì›Œí¬ì¸íŠ¸') || query.includes('ppt') || query.includes('pptx')) && ['ppt', 'pptx'].includes(ext)) {
      return { type: 'íŒŒì›Œí¬ì¸íŠ¸ íŒŒì¼', emoji: 'ðŸ“½ï¸', priority: 1 };
    }
    if ((query.includes('í…ìŠ¤íŠ¸') || query.includes('txt')) && ext === 'txt') {
      return { type: 'í…ìŠ¤íŠ¸ íŒŒì¼', emoji: 'ðŸ“„', priority: 1 };
    }
    
    // ì¹´í…Œê³ ë¦¬ë³„ ë§¤ì¹­
    const imageExts = ['jpg', 'jpeg', 'png', 'gif', 'bmp', 'svg', 'webp', 'tiff', 'ico'];
    if ((query.includes('ì´ë¯¸ì§€') || query.includes('ì‚¬ì§„') || query.includes('image') || query.includes('photo')) && imageExts.includes(ext)) {
      return { type: 'ì´ë¯¸ì§€ íŒŒì¼', emoji: 'ðŸ–¼ï¸', priority: 2 };
    }
    
    const videoExts = ['mp4', 'avi', 'mov', 'mkv', 'wmv', 'flv', 'webm', 'm4v', '3gp', 'ogv', 'mpg', 'mpeg'];
    if ((query.includes('ë™ì˜ìƒ') || query.includes('video')) && videoExts.includes(ext)) {
      return { type: 'ë™ì˜ìƒ íŒŒì¼', emoji: 'ðŸŽ¬', priority: 2 };
    }
    
    const audioExts = ['mp3', 'wav', 'flac', 'aac', 'ogg', 'wma', 'm4a', 'opus'];
    if ((query.includes('ìŒì•…') || query.includes('music')) && audioExts.includes(ext)) {
      return { type: 'ìŒì•… íŒŒì¼', emoji: 'ðŸŽµ', priority: 2 };
    }
    
    const archiveExts = ['zip', 'rar', '7z', 'tar', 'gz', 'bz2', 'xz', 'iso'];
    if (query.includes('ì••ì¶•') && archiveExts.includes(ext)) {
      return { type: 'ì••ì¶• íŒŒì¼', emoji: 'ðŸ“¦', priority: 2 };
    }
    
    const codeExts = ['js', 'jsx', 'ts', 'tsx', 'py', 'java', 'cpp', 'c', 'html', 'css', 'php', 'rb', 'go', 'rs', 'swift', 'kt', 'scala', 'sh', 'bat', 'ps1', 'sql', 'json', 'xml', 'yaml', 'yml', 'toml', 'ini', 'cfg', 'conf'];
    if (query.includes('ì½”ë“œ') && codeExts.includes(ext)) {
      return { type: 'ì½”ë“œ íŒŒì¼', emoji: 'ðŸ’»', priority: 2 };
    }
    
    const exeExts = ['exe', 'msi', 'dmg', 'pkg', 'deb', 'rpm', 'app', 'apk', 'ipa', 'run', 'bin', 'com', 'scr', 'bat', 'cmd', 'ps1', 'vbs', 'jar', 'war'];
    if (query.includes('ì‹¤í–‰íŒŒì¼') && exeExts.includes(ext)) {
      return { type: 'ì‹¤í–‰ íŒŒì¼', emoji: 'âš™ï¸', priority: 2 };
    }
    
    return { type: 'íŒŒì¼', emoji: 'ðŸ“„', priority: 3 };
  }

  // 3. ìžì—°ì–´ ëª…ë ¹ì—ì„œ ë‚ ì§œ/í¬ê¸°/ê¸°íƒ€ ì¡°ê±´ ì¶”ì¶œ (ê°„ë‹¨ ë²„ì „)
  function extractAdvancedFilters(query) {
    const filters = {};
    // ë‚ ì§œ ì¡°ê±´
    if (/ì˜¤ëŠ˜|ìµœê·¼|1ì¼|í•˜ë£¨/.test(query)) filters.days = 1;
    else if (/3ì¼/.test(query)) filters.days = 3;
    else if (/7ì¼|ì¼ì£¼ì¼/.test(query)) filters.days = 7;
    else if (/í•œë‹¬|30ì¼/.test(query)) filters.days = 30;
    // í¬ê¸° ì¡°ê±´
    const sizeMatch = query.match(/([0-9]+) ?(MB|GB|KB)/i);
    if (sizeMatch) {
      const size = parseInt(sizeMatch[1], 10);
      const unit = sizeMatch[2].toUpperCase();
      let bytes = size;
      if (unit === 'KB') bytes *= 1024;
      if (unit === 'MB') bytes *= 1024*1024;
      if (unit === 'GB') bytes *= 1024*1024*1024;
      filters.minSize = bytes;
    }
    // ì¤‘ë³µ, ì •ë ¬ ë“± ê¸°íƒ€ í‚¤ì›Œë“œ
    if (/ì¤‘ë³µ/.test(query)) filters.duplicate = true;
    if (/ì •ë ¬/.test(query)) filters.sort = true;
    return filters;
  }

  // ì¶”ì²œ ì§ˆë¬¸ ìžë™ ìƒì„± (aiSuggestions)
  useEffect(() => {
    // ìµœê·¼ í´ë”/íŒŒì¼/ëª…ë ¹ ë§¥ë½ ê¸°ë°˜ ì¶”ì²œ ì§ˆë¬¸ ì˜ˆì‹œ
    setAiSuggestions([
      'ìµœê·¼ ì´ë¯¸ì§€ íŒŒì¼ ì°¾ì•„ì¤˜',
      'ë¬¸ì„œ íŒŒì¼ë§Œ ì •ë¦¬í•´ì¤˜',
      '10MB ì´ìƒ ë™ì˜ìƒë§Œ ë³´ì—¬ì¤˜',
      'ì¤‘ë³µ íŒŒì¼ ì°¾ì•„ì¤˜',
      'ìµœê·¼ ìˆ˜ì •ëœ ì½”ë“œ íŒŒì¼ë§Œ ë³´ì—¬ì¤˜',
      'ì••ì¶•íŒŒì¼ë§Œ ì°¾ì•„ì„œ ì••ì¶• í’€ì–´ì¤˜',
      'ì´ í´ë”ì—ì„œ 3ì¼ ì´ë‚´ ìƒì„±ëœ íŒŒì¼ë§Œ ë³´ì—¬ì¤˜',
      'ìŒì•… íŒŒì¼ë§Œ í¬ê¸°ìˆœìœ¼ë¡œ ì •ë ¬í•´ì¤˜',
      'AIë¡œ íŒŒì¼ ìžë™ ë¶„ë¥˜í•´ì¤˜'
    ]);
  }, [currentPath, files]);

  // í•„í„° ë²„íŠ¼ í´ë¦­ í•¸ë“¤ëŸ¬
  const handleFilterClick = (filterId) => {
    if (filterId === 'all') {
      setActiveFilters(['all']);
    } else {
      setActiveFilters(prev => {
        const next = prev.includes(filterId)
          ? prev.filter(id => id !== filterId)
          : [...prev.filter(id => id !== 'all'), filterId];
        return next.length === 0 ? ['all'] : next;
      });
    }
  };

  return (
    <div className={`h-screen ${darkMode ? 'dark' : ''} transition-all duration-300 flex flex-col`}>
      <style>{hideScrollbarStyle}</style>
      <div className="flex-1 bg-gradient-to-br from-slate-50 via-blue-50 to-indigo-50 dark:from-gray-900 dark:via-gray-800 dark:to-gray-900 flex font-inter overflow-hidden">
        
        {/* --- ë©”ë‰´ë°” (ë§¨ ì¢Œì¸¡) --- */}
        {showMenuBar && (
          <aside className="fixed left-0 top-0 bottom-0 w-16 bg-gray-900/95 dark:bg-gray-950/95 backdrop-blur-xl border-r border-gray-700/50 flex flex-col items-center py-4 space-y-3 shadow-2xl z-50">
            {menuItems.map((item) => (
              <button
                key={item.id}
                onClick={() => handleMenuClick(item.id)}
                className={`w-12 h-12 rounded-xl flex items-center justify-center transition-all hover:scale-110 group ${
                  selectedMenuItem === item.id 
                    ? 'bg-blue-600/80 shadow-lg' 
                    : 'bg-gray-800/50 hover:bg-gray-700/70'
                }`}
                title={item.label}
              >
                <item.icon className={`w-5 h-5 ${
                  selectedMenuItem === item.id ? 'text-white' : item.color
                } group-hover:scale-110 transition-transform`} />
              </button>
            ))}
            
            {/* êµ¬ë¶„ì„  */}
            <div className="w-8 h-px bg-gray-700/50 my-2"></div>
            
            {/* ìœ ì € ë¦¬ìŠ¤íŠ¸ í† ê¸€ */}
            <button
              onClick={() => setShowUserList(!showUserList)}
              className={`w-12 h-12 rounded-xl flex items-center justify-center transition-all hover:scale-110 ${
                showUserList ? 'bg-blue-600/80 hover:bg-blue-500/80' : 'bg-gray-800/50 hover:bg-gray-700/70'
              }`}
              title="íŒ€ì› ëª©ë¡"
            >
              <UserGroupIcon className={`w-5 h-5 ${showUserList ? 'text-white' : 'text-gray-400'} transition-colors`} />
            </button>
          </aside>
        )}

        {/* --- ìœ ì € ë¦¬ìŠ¤íŠ¸ (Teams ìŠ¤íƒ€ì¼) --- */}
        {showUserList && (
          <aside className={`fixed top-0 bottom-0 bg-white/95 dark:bg-gray-900/95 backdrop-blur-xl border-r border-gray-200/50 dark:border-gray-700/50 shadow-xl z-40 transition-all duration-300 ${
            showMenuBar ? 'left-16' : 'left-0'
          } ${userListCollapsed ? 'w-16' : 'w-72'}`}>
            
            {/* í—¤ë” */}
            <div className="p-4 border-b border-gray-200/50 dark:border-gray-700/50 flex items-center justify-between">
              {!userListCollapsed && (
                <h3 className="font-bold text-gray-900 dark:text-gray-100 flex items-center">
                  <UserGroupIcon className="w-5 h-5 mr-2 text-blue-500" />
                  íŒ€ì› ({onlineUsers.filter(u => u.status === 'online' || u.status === 'busy').length}ëª… í™œì„±)
                </h3>
              )}
              <button
                onClick={() => setUserListCollapsed(!userListCollapsed)}
                className="p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-800 transition-colors"
                title={userListCollapsed ? 'íŽ¼ì¹˜ê¸°' : 'ì ‘ê¸°'}
              >
                {userListCollapsed ? (
                  <svg className="w-4 h-4 text-gray-600 dark:text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 5l7 7-7 7" />
                  </svg>
                ) : (
                  <svg className="w-4 h-4 text-gray-600 dark:text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 19l-7-7 7-7" />
                  </svg>
                )}
              </button>
            </div>
            
            {/* ìœ ì € ëª©ë¡ */}
            <div className="overflow-y-auto flex-1">
              {userListCollapsed ? (
                // ì ‘ížŒ ìƒíƒœ: ì•„ë°”íƒ€ë§Œ í‘œì‹œ
                <div className="p-2 space-y-2">
                  {onlineUsers.map((user) => (
                    <div key={user.id} className="relative group">
                      <button
                        className="w-12 h-12 rounded-full bg-gradient-to-br text-white font-bold text-sm flex items-center justify-center hover:scale-105 transition-all shadow-lg"
                        style={{backgroundImage: `linear-gradient(to bottom right, var(--tw-gradient-stops))`}}
                        title={`${user.name} - ${user.title}`}
                        onClick={(e) => handleUserProfileClick(user, e)}
                      >
                        <div className={`w-12 h-12 rounded-full bg-gradient-to-br ${user.avatarColor} flex items-center justify-center text-white font-bold text-sm`}>
                          {user.avatar}
                        </div>
                      </button>
                      
                      {/* ìƒíƒœ í‘œì‹œ */}
                      <div className={`absolute -bottom-0.5 -right-0.5 w-4 h-4 rounded-full border-2 border-white dark:border-gray-900 ${
                        user.status === 'online' ? 'bg-green-500' : 
                        user.status === 'busy' ? 'bg-red-500' :
                        user.status === 'away' ? 'bg-yellow-500' : 'bg-gray-500'
                      }`}></div>
                    </div>
                  ))}
                </div>
              ) : (
                // íŽ¼ì¹œ ìƒíƒœ: ì „ì²´ ì •ë³´ í‘œì‹œ
                <div className="p-4 space-y-1">
                  {onlineUsers.map((user) => (
                    <div 
                      key={user.id} 
                      className="flex items-center space-x-3 p-3 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-800 transition-colors group cursor-pointer"
                      onClick={(e) => handleUserProfileClick(user, e)}
                    >
                      <div className="relative">
                        <div className={`w-10 h-10 rounded-full bg-gradient-to-br ${user.avatarColor} flex items-center justify-center text-white font-bold text-sm shadow-lg`}>
                          {user.avatar}
                        </div>
                        <div className={`absolute -bottom-0.5 -right-0.5 w-4 h-4 rounded-full border-2 border-white dark:border-gray-900 ${
                          user.status === 'online' ? 'bg-green-500' : 
                          user.status === 'busy' ? 'bg-red-500' :
                          user.status === 'away' ? 'bg-yellow-500' : 'bg-gray-500'
                        }`}></div>
                      </div>
                      
                      <div className="flex-1 min-w-0">
                        <div className="font-semibold text-gray-900 dark:text-gray-100 truncate text-sm">
                          {user.name}
                        </div>
                        <div className="text-xs text-gray-600 dark:text-gray-400 truncate">
                          {user.title}
                        </div>
                        {user.currentActivity && user.status !== 'offline' && (
                          <div className="text-xs text-blue-600 dark:text-blue-400 truncate flex items-center">
                            ðŸ“„ {user.currentActivity.file}
                          </div>
                        )}
                        <div className={`text-xs flex items-center ${
                          user.status === 'online' ? 'text-green-600 dark:text-green-400' : 
                          user.status === 'busy' ? 'text-red-600 dark:text-red-400' :
                          user.status === 'away' ? 'text-yellow-600 dark:text-yellow-400' : 'text-gray-500 dark:text-gray-500'
                        }`}>
                          <div className={`w-2 h-2 rounded-full mr-1 ${
                            user.status === 'online' ? 'bg-green-500' : 
                            user.status === 'busy' ? 'bg-red-500' :
                            user.status === 'away' ? 'bg-yellow-500' : 'bg-gray-500'
                          }`}></div>
                          {user.status === 'online' ? 'ì‚¬ìš© ê°€ëŠ¥' : 
                           user.status === 'busy' ? 'ë‹¤ë¥¸ ìš©ë¬´ ì¤‘' :
                           user.status === 'away' ? 'ìžë¦¬ ë¹„ì›€' : 
                           user.lastSeen ? `${user.lastSeen} ë§ˆì§€ë§‰ ì ‘ì†` : 'ì˜¤í”„ë¼ì¸'}
                        </div>
                      </div>
                      
                      {(user.status === 'online' || user.status === 'busy' || user.status === 'away') && (
                        <button
                          onClick={(e) => {
                            e.stopPropagation();
                            setMessengerExpanded(true);
                          }}
                          className="opacity-0 group-hover:opacity-100 w-8 h-8 rounded-lg bg-blue-500 hover:bg-blue-600 flex items-center justify-center transition-all"
                          title="ë©”ì‹œì§€ ë³´ë‚´ê¸°"
                        >
                          <ChatBubbleLeftRightIcon className="w-4 h-4 text-white" />
                        </button>
                      )}
                    </div>
                  ))}
                </div>
              )}
            </div>
          </aside>
        )}

        
        {/* --- ë©”ì¸ ì½˜í…ì¸  ì˜ì—­ (ë™ì  íŒ¨ë”©) --- */}
        <div className={`flex-1 flex flex-col transition-all duration-300 ${
          showMenuBar ? 
            (showUserList ? (userListCollapsed ? 'ml-32' : 'ml-88') : 'ml-16') : 
            (showUserList ? (userListCollapsed ? 'ml-16' : 'ml-72') : 'ml-0')
        }`}>
        
        {/* Filo í—¤ë” */}
        <header className="sticky top-0 z-30 bg-white/80 dark:bg-gray-900/80 backdrop-blur-xl border-b border-gray-200/50 dark:border-gray-700/50 shadow-sm">
          <div className="px-6 py-4">
            <div className="flex items-center justify-between">
              {/* ì¢Œì¸¡: Filo ë¸Œëžœë”© */}
              <div className="flex items-center space-x-6">
                <div className="flex items-center space-x-3">
                  <div className="w-8 h-8 bg-gradient-to-tr from-blue-600 to-purple-600 rounded-xl flex items-center justify-center">
                    <SparklesSolidIcon className="w-5 h-5 text-white" />
                  </div>
                  <div>
                    <h1 className="text-xl font-bold bg-gradient-to-r from-blue-600 to-purple-600 bg-clip-text text-transparent">
                      Filo
                    </h1>
                    <p className="text-xs text-gray-500 dark:text-gray-400">AI íŒŒì¼ ë§¤ë‹ˆì €</p>
                  </div>
                </div>

                <div className="h-6 w-px bg-gray-300 dark:bg-gray-600"></div>

                <button
                  onClick={() => setShowSidebar(!showSidebar)}
                  className="p-2 rounded-xl hover:bg-gray-100 dark:hover:bg-gray-800 transition-colors"
                >
                  <ViewColumnsIcon className="w-5 h-5 text-gray-600 dark:text-gray-400" />
                </button>
                
                {/* ë¸Œë ˆë“œí¬ëŸ¼ */}
                <nav className="flex items-center space-x-2">
                  <HomeIcon className="w-4 h-4 text-gray-400" />
                  {breadcrumbs.map((crumb, index) => (
                    <React.Fragment key={index}>
                      <span className="text-gray-400">/</span>
                      <button
                        onClick={() => handleBreadcrumbClick(crumb.path)}
                        className="px-3 py-1.5 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-800 text-sm font-medium text-gray-700 dark:text-gray-300 transition-colors"
                      >
                        {crumb.name}
                      </button>
                    </React.Fragment>
                  ))}
                </nav>
              </div>

              {/* ìš°ì¸¡: ë„êµ¬ë“¤ */}
              <div className="flex items-center space-x-4">
                {/* ê³ ê¸‰ ê²€ìƒ‰ */}
                <div className="relative">
                  <MagnifyingGlassIcon className="absolute left-4 top-1/2 transform -translate-y-1/2 w-5 h-5 text-gray-400" />
                  <input
                    type="text"
                    placeholder="AI ê²€ìƒ‰ìœ¼ë¡œ ì°¾ê¸°..."
                    value={searchQuery}
                    onChange={(e) => setSearchQuery(e.target.value)}
                    className="pl-12 pr-6 py-3 w-80 bg-white/70 dark:bg-gray-800/70 border border-gray-200 dark:border-gray-600 rounded-2xl focus:ring-2 focus:ring-blue-500 focus:border-transparent backdrop-blur-sm text-gray-900 dark:text-gray-100 placeholder-gray-500 dark:placeholder-gray-400 transition-all"
                  />
                </div>

                {/* ë·° ëª¨ë“œ ì„ íƒ */}
                <div className="flex items-center bg-gray-100 dark:bg-gray-800 rounded-xl p-1">
                  <button
                    onClick={() => setViewMode('grid')}
                    className={`p-2 rounded-lg transition-all ${
                      viewMode === 'grid' 
                        ? 'bg-white dark:bg-gray-700 shadow-sm text-blue-600' 
                        : 'text-gray-600 dark:text-gray-400 hover:text-gray-900 dark:hover:text-gray-200'
                    }`}
                    title="ê·¸ë¦¬ë“œ ë·°"
                  >
                    <Squares2X2Icon className="w-5 h-5" />
                  </button>
                  <button
                    onClick={() => setViewMode('list')}
                    className={`p-2 rounded-lg transition-all ${
                      viewMode === 'list' 
                        ? 'bg-white dark:bg-gray-700 shadow-sm text-blue-600' 
                        : 'text-gray-600 dark:text-gray-400 hover:text-gray-900 dark:hover:text-gray-200'
                    }`}
                    title="ë¦¬ìŠ¤íŠ¸ ë·°"
                  >
                    <ListBulletIcon className="w-5 h-5" />
                  </button>
                  <button
                    onClick={() => setViewMode('compact')}
                    className={`p-2 rounded-lg transition-all ${
                      viewMode === 'compact' 
                        ? 'bg-white dark:bg-gray-700 shadow-sm text-blue-600' 
                        : 'text-gray-600 dark:text-gray-400 hover:text-gray-900 dark:hover:text-gray-200'
                    }`}
                    title="ì½¤íŒ©íŠ¸ ë·°"
                  >
                    <Bars3BottomLeftIcon className="w-5 h-5" />
                  </button>
                </div>

                {/* ë‹¤í¬ëª¨ë“œ í† ê¸€ */}
                <button
                  onClick={() => setDarkMode(!darkMode)}
                  className="p-3 rounded-xl hover:bg-gray-100 dark:hover:bg-gray-800 border border-gray-200 dark:border-gray-700 transition-all"
                >
                  {darkMode ? 
                    <SunIcon className="w-5 h-5 text-amber-500" /> : 
                    <MoonIcon className="w-5 h-5 text-gray-600" />
                  }
                </button>

                {/* ë©”ì‹ ì € í† ê¸€ */}
                <button
                  onClick={() => setMessengerExpanded(!messengerExpanded)}
                  className="relative p-3 rounded-xl bg-gradient-to-r from-green-600 to-emerald-600 text-white hover:from-green-700 hover:to-emerald-700 transition-all shadow-lg"
                >
                  <ChatBubbleLeftRightIcon className="w-5 h-5" />
                  {messages.length > 0 && (
                    <span className="absolute -top-1 -right-1 w-3 h-3 bg-red-500 rounded-full"></span>
                  )}
                </button>

                {/* AI ì±„íŒ… í† ê¸€ */}
                <button
                  onClick={() => setAiChatExpanded(!aiChatExpanded)}
                  className="relative p-3 rounded-xl bg-gradient-to-r from-purple-600 to-blue-600 text-white hover:from-purple-700 hover:to-blue-700 transition-all shadow-lg"
                >
                  <SparklesIcon className="w-5 h-5" />
                  {chatHistory.length > 0 && (
                    <span className="absolute -top-1 -right-1 w-3 h-3 bg-red-500 rounded-full"></span>
                  )}
                </button>
              </div>
            </div>
          </div>
        </header>

        <div className="flex flex-1 h-full">
          {/* ê°œì„ ëœ ì‚¬ì´ë“œë°” */}
          {showSidebar && (
            <aside className="w-80 bg-white/60 dark:bg-gray-900/60 backdrop-blur-xl border-r border-gray-200/50 dark:border-gray-700/50 flex flex-col overflow-y-auto hide-scrollbar">
              

              {/* ì´ PC */}
              <div className="px-6 pb-4">
                <h3 className="text-sm font-bold text-gray-900 dark:text-gray-100 mb-4 flex items-center">
                  <ComputerDesktopIcon className="w-4 h-4 mr-2 text-blue-500" />
                  ì´ PC
                </h3>
                <div className="space-y-2">
                  {/* ë“œë¼ì´ë¸Œë“¤ */}
                  {drives.map((drive) => (
                    <button
                      key={drive.name}
                      onClick={() => handleDriveClick(drive)}
                      className={`w-full flex items-center space-x-3 p-3 rounded-xl text-left transition-all hover:bg-gray-50 dark:hover:bg-gray-800 ${
                        currentPath === drive.name ? 'bg-blue-50 dark:bg-blue-900/20' : ''
                      }`}
                    >
                      <div className="w-10 h-10 rounded-xl bg-gradient-to-br from-gray-100 to-gray-200 dark:from-gray-700 dark:to-gray-800 flex items-center justify-center">
                        <ComputerDesktopIcon className="w-5 h-5 text-gray-600 dark:text-gray-400" />
                      </div>
                      <div className="flex-1 min-w-0">
                        <div className="font-semibold text-gray-900 dark:text-gray-100">
                          ë¡œì»¬ ë””ìŠ¤í¬ ({drive.name})
                        </div>
                        <div className="text-xs text-gray-500 dark:text-gray-400">
                          ì—¬ìœ  ê³µê°„: {formatFileSize(drive.freeSpace)}
                        </div>
                        <div className="mt-1 w-full bg-gray-200 dark:bg-gray-700 rounded-full h-1.5">
                          <div 
                            className="bg-gradient-to-r from-blue-500 to-blue-600 h-1.5 rounded-full" 
                            style={{ width: `${drive.size > 0 ? ((drive.size - drive.freeSpace) / drive.size) * 100 : 0}%` }}
                          ></div>
                        </div>
                      </div>
                    </button>
                  ))}
                </div>
              </div>

              {/* ì¦ê²¨ì°¾ê¸° */}
              <div className="px-6 pb-4">
                <div className="flex items-center justify-between mb-4">
                  <h3 className="text-sm font-bold text-gray-900 dark:text-gray-100 flex items-center">
                    <HeartSolidIcon className="w-4 h-4 mr-2 text-red-500" />
                    ì¦ê²¨ì°¾ê¸°
                    {favorites.length > 0 && (
                      <span className="ml-2 text-xs bg-gray-200 dark:bg-gray-700 text-gray-600 dark:text-gray-300 px-2 py-1 rounded-full">
                        {favorites.length}
                      </span>
                    )}
                  </h3>
                  {favorites.length >= 10 && (
                    <button
                      onClick={() => setFavoritesCollapsed(!favoritesCollapsed)}
                      className="p-1 rounded-md hover:bg-gray-100 dark:hover:bg-gray-800 transition-colors"
                      title={favoritesCollapsed ? "íŽ¼ì¹˜ê¸°" : "ì ‘ê¸°"}
                    >
                      {favoritesCollapsed ? (
                        <ChevronDownIcon className="w-4 h-4 text-gray-500" />
                      ) : (
                        <ChevronUpIcon className="w-4 h-4 text-gray-500" />
                      )}
                    </button>
                  )}
                </div>
                <div className="space-y-1">
                  {favorites.length === 0 ? (
                    <div className="text-center py-4 text-gray-500 dark:text-gray-400 text-sm">
                      ì¦ê²¨ì°¾ê¸°í•œ í´ë”ê°€ ì—†ìŠµë‹ˆë‹¤.
                      <br />
                      í´ë” ì˜†ì˜ â­ë¥¼ í´ë¦­í•´ë³´ì„¸ìš”!
                    </div>
                  ) : (
                    <>
                      {(favoritesCollapsed ? favorites.slice(0, 5) : favorites).map((folder) => (
                        <button
                          key={folder.id}
                          onClick={() => handleQuickAccessClick(folder)}
                          className={`w-full flex items-center space-x-3 p-2 rounded-xl text-left transition-all hover:bg-yellow-50 dark:hover:bg-yellow-900/20 group ${
                            currentPath === folder.path ? 'bg-yellow-50 dark:bg-yellow-900/20' : ''
                          }`}
                        >
                          <div className={`w-8 h-8 rounded-lg bg-gradient-to-br ${folder.gradient} flex items-center justify-center`}>
                            <folder.icon className="w-4 h-4 text-white" />
                          </div>
                          <span className="font-medium text-gray-900 dark:text-gray-100 text-sm flex-1">{folder.label}</span>
                          {folder.type !== 'default' && (
                            <button
                              onClick={(e) => {
                                e.stopPropagation();
                                toggleFavorite({ path: folder.path });
                              }}
                              className="opacity-0 group-hover:opacity-100 p-1 hover:bg-red-100 dark:hover:bg-red-900/20 rounded transition-all"
                              title="ì¦ê²¨ì°¾ê¸°ì—ì„œ ì œê±°"
                            >
                              <svg className="w-3 h-3 text-red-500" fill="currentColor" viewBox="0 0 20 20">
                                <path fillRule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clipRule="evenodd" />
                              </svg>
                            </button>
                          )}
                        </button>
                      ))}
                      {favoritesCollapsed && favorites.length > 5 && (
                        <button
                          onClick={() => setFavoritesCollapsed(false)}
                          className="w-full text-center py-2 text-sm text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-200 transition-colors"
                        >
                          ...ê·¸ë¦¬ê³  {favorites.length - 5}ê°œ ë”
                        </button>
                      )}
                    </>
                  )}
                </div>
              </div>

              {/* AI ê¸°ëŠ¥ ë©”ë‰´ */}
              <div className="px-6 pb-6">
                <h3 className="text-sm font-bold text-gray-900 dark:text-gray-100 mb-4 flex items-center">
                  <SparklesIcon className="w-4 h-4 mr-2 text-purple-500" />
                  AI ê¸°ëŠ¥
                </h3>
                <div className="space-y-2">
                  {aiFeatures.map((feature) => (
                    <button
                      key={feature.id}
                      className="w-full flex items-center space-x-4 p-3 rounded-xl text-left hover:bg-gradient-to-r hover:from-purple-50 hover:to-blue-50 dark:hover:from-purple-900/20 dark:hover:to-blue-900/20 transition-all group"
                    >
                      <div className={`w-10 h-10 rounded-lg bg-gradient-to-br ${feature.gradient} flex items-center justify-center group-hover:scale-110 transition-transform`}>
                        <feature.icon className="w-5 h-5 text-white" />
                      </div>
                      <div className="flex-1">
                        <div className="font-medium text-gray-900 dark:text-gray-100 group-hover:text-purple-600 dark:group-hover:text-purple-400 transition-colors">
                          {feature.label}
                        </div>
                        <div className="text-xs text-gray-500 dark:text-gray-400">
                          {feature.description}
                        </div>
                      </div>
                    </button>
                  ))}
                </div>
              </div>

              {/* í”„ë¡œíŽ˜ì…”ë„ ë„êµ¬ */}
              <div className="px-6 pb-6">
                <h3 className="text-sm font-bold text-gray-900 dark:text-gray-100 mb-4 flex items-center">
                  <Cog6ToothIcon className="w-4 h-4 mr-2 text-gray-500" />
                  ë„êµ¬
                </h3>
                <div className="grid grid-cols-2 gap-2">
                  {professionalTools.map((tool) => (
                    <button
                      key={tool.id}
                      className="p-3 rounded-xl bg-gray-50 dark:bg-gray-800 hover:bg-gray-100 dark:hover:bg-gray-700 transition-all group"
                    >
                      <tool.icon className={`w-5 h-5 ${tool.color} mx-auto mb-1 group-hover:scale-110 transition-transform`} />
                      <div className="text-xs font-medium text-gray-700 dark:text-gray-300 text-center">
                        {tool.label}
                      </div>
                    </button>
                  ))}
                </div>
              </div>
            </aside>
          )}

          {/* ë©”ì¸ ì½˜í…ì¸  ì˜ì—­ */}
          <main className="flex-1 flex flex-col h-full">
            
            {/* íŒŒì¼ ëª©ë¡ ì»¨í…Œì´ë„ˆ */}
            <div className="flex-1 flex flex-col h-full">
              {/* íŒŒì¼ í•„í„° ë‹¨ì¼ í–‰ */}
              <div className="px-6 py-3 bg-white/40 dark:bg-gray-900/40 backdrop-blur-sm border-b border-gray-200/50 dark:border-gray-700/50">
                <div className="flex items-center space-x-3">
                  <FunnelIcon className="w-4 h-4 text-blue-500" />
                  <span className="text-sm font-medium text-gray-900 dark:text-gray-100">í•„í„°:</span>
                  <div className="flex space-x-2">
                    {relevantFilters.map((filter) => (
                      <button
                        key={filter.id}
                        onClick={() => handleFilterClick(filter.id)}
                        className={`flex items-center space-x-1 px-2.5 py-1 rounded-full text-xs font-medium transition-all ${
                          activeFilters.includes(filter.id)
                            ? 'bg-blue-500 text-white shadow-md'
                            : 'bg-white/60 dark:bg-gray-800/60 text-gray-700 dark:text-gray-300 hover:bg-blue-50 dark:hover:bg-blue-900/20 border border-gray-200/50 dark:border-gray-700/50'
                        }`}
                      >
                        <filter.icon className="w-3 h-3" />
                        <span>{filter.label}</span>
                      </button>
                    ))}
                  </div>
                </div>
              </div>
              
              {/* ë©”ì¸ ì½˜í…ì¸  ì˜ì—­ - ìŠ¤í¬ë¡¤ ê°€ëŠ¥ (ìŠ¤í¬ë¡¤ë°” ìˆ¨ê¹€), í•˜ë‹¨ ì—¬ë°± ì¶”ê°€ */}
              <div 
                className={`flex-1 p-6 overflow-y-auto hide-scrollbar ${
                  dragOver ? 'bg-blue-50 dark:bg-blue-900/20 border-2 border-dashed border-blue-400' : ''
                }`}
                onDragOver={handleDragOver}
                onDragLeave={handleDragLeave}
                onDrop={handleDrop}
              >
              {loading ? (
                <div className="flex flex-col items-center justify-center h-full">
                  <div className="relative">
                    <div className="animate-spin rounded-full h-16 w-16 border-4 border-blue-200 border-t-blue-600"></div>
                    <SparklesIcon className="w-6 h-6 text-blue-600 absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2" />
                  </div>
                  <p className="mt-4 text-gray-600 dark:text-gray-400 font-medium">AIê°€ íŒŒì¼ì„ ë¶„ì„í•˜ê³  ìžˆìŠµë‹ˆë‹¤...</p>
                </div>
              ) : activeFilters.includes('group') ? (
                // ê·¸ë£¹ ë·°: í™•ìž¥ìžë³„ë¡œ ì„¹ì…˜ ë‚˜ëˆ„ì–´ì„œ í‘œì‹œ
                <div className="space-y-8">
                  {(() => {
                    // íŒŒì¼ë“¤ì„ í™•ìž¥ìžë³„ë¡œ ê·¸ë£¹í™”
                    const groups = {};
                    const folders = [];
                    
                    filteredFiles.forEach(file => {
                      if (file.isDirectory) {
                        folders.push(file);
                      } else {
                        const ext = file.name.includes('.') ? file.name.split('.').pop().toLowerCase() : 'no-extension';
                        if (!groups[ext]) groups[ext] = [];
                        groups[ext].push(file);
                      }
                    });
                    
                    return (
                      <>
                        {/* í´ë” ì„¹ì…˜ */}
                        {folders.length > 0 && (
                          <div>
                            <h3 className="text-lg font-semibold text-gray-900 dark:text-gray-100 mb-4 flex items-center">
                              <FolderIcon className="w-5 h-5 mr-2 text-amber-500" />
                              í´ë” ({folders.length}ê°œ)
                            </h3>
                            <div className={viewMode === 'grid' 
                              ? 'grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-6 xl:grid-cols-8 2xl:grid-cols-10 gap-4' 
                              : viewMode === 'compact'
                              ? 'space-y-1'
                              : 'space-y-2'
                            }>
                              {folders.map((file) => {
                                const isSelected = selectedFiles.some(f => f.path === file.path);
                                return viewMode === 'grid' ? (
                                  <div
                                    key={file.path}
                                    className={`group relative p-4 rounded-2xl cursor-pointer transition-all duration-300 hover:scale-105 ${
                                      isSelected 
                                        ? 'bg-blue-50 dark:bg-blue-900/30 border-2 border-blue-500 shadow-lg' 
                                        : 'bg-white/60 dark:bg-gray-800/60 border border-gray-200/50 dark:border-gray-700/50 hover:bg-white dark:hover:bg-gray-800 hover:shadow-xl hover:border-blue-300 dark:hover:border-blue-600'
                                    } backdrop-blur-sm`}
                                    onClick={(e) => handleFileSelect(file, e)}
                                    onDoubleClick={() => handleFileDoubleClick(file)}
                                    onContextMenu={(e) => handleContextMenu(e, file)}
                                  >
                                    <div className="flex flex-col items-center text-center">
                                      <div className="mb-3 transition-all group-hover:scale-110">
                                        {getFileThumbnail(file)}
                                      </div>
                                      <div className="text-sm font-medium text-gray-900 dark:text-gray-100 truncate w-full mb-1">
                                        {file.name}
                                      </div>
                                      <div className="text-xs text-gray-500 dark:text-gray-400">
                                        {file.isDirectory ? 'í´ë”' : formatFileSize(file.size)}
                                      </div>
                                    </div>
                                    <button
                                      onClick={(e) => {
                                        e.stopPropagation();
                                        toggleFavorite(file);
                                      }}
                                      className={`absolute top-2 right-2 w-6 h-6 rounded-full flex items-center justify-center transition-all hover:scale-110 ${
                                        isFavorite(file.path) 
                                          ? 'bg-yellow-500 text-white shadow-lg' 
                                          : 'bg-white/80 dark:bg-gray-800/80 text-gray-400 hover:text-yellow-500 opacity-0 group-hover:opacity-100'
                                      }`}
                                    >
                                      {isFavorite(file.path) ? (
                                        <HeartSolidIcon className="w-4 h-4" />
                                      ) : (
                                        <StarIcon className="w-4 h-4" />
                                      )}
                                    </button>
                                  </div>
                                ) : viewMode === 'compact' ? (
                                  // ì»´íŒ©íŠ¸ ë·° - ê·¸ë£¹ ì„¹ì…˜
                                  <div
                                    key={file.path}
                                    className={`group flex items-center space-x-2 px-3 py-1 rounded-lg cursor-pointer transition-all hover:bg-gray-50 dark:hover:bg-gray-800 ${
                                      isSelected 
                                        ? 'bg-blue-50 dark:bg-blue-900/30 border-l-2 border-blue-500' 
                                        : 'hover:border-l-2 hover:border-gray-300 dark:hover:border-gray-600'
                                    }`}
                                    onClick={(e) => handleFileSelect(file, e)}
                                    onDoubleClick={() => handleFileDoubleClick(file)}
                                    onContextMenu={(e) => handleContextMenu(e, file)}
                                  >
                                    <div className="flex-shrink-0 w-4 h-4">
                                      {React.createElement(getFileIcon(file), { className: "w-4 h-4 text-gray-600 dark:text-gray-400" })}
                                    </div>
                                    <div className="flex-1 min-w-0 text-sm">
                                      <span className="font-medium text-gray-900 dark:text-gray-100 truncate block">
                                        {file.name}
                                      </span>
                                    </div>
                                    <div className="flex-shrink-0 text-xs text-gray-500 dark:text-gray-400 w-20 text-right">
                                      {file.isDirectory ? 'í´ë”' : formatFileSize(file.size)}
                                    </div>
                                    <button
                                      onClick={(e) => {
                                        e.stopPropagation();
                                        toggleFavorite(file);
                                      }}
                                      className={`flex-shrink-0 w-4 h-4 rounded-sm flex items-center justify-center transition-all ${
                                        isFavorite(file.path) 
                                          ? 'text-yellow-500' 
                                          : 'text-gray-300 hover:text-yellow-500 opacity-0 group-hover:opacity-100'
                                      }`}
                                    >
                                      {isFavorite(file.path) ? (
                                        <HeartSolidIcon className="w-3 h-3" />
                                      ) : (
                                        <StarIcon className="w-3 h-3" />
                                      )}
                                    </button>
                                  </div>
                                ) : (
                                  <div key={file.path} className="flex items-center space-x-4 p-3 rounded-2xl">
                                    <div className="flex-shrink-0">
                                      {getFileThumbnail(file)}
                                    </div>
                                    <div className="flex-1 min-w-0">
                                      <div className="text-sm font-medium text-gray-900 dark:text-gray-100 truncate">
                                        {file.name}
                                      </div>
                                      <div className="text-xs text-gray-500 dark:text-gray-400">
                                        {file.isDirectory ? 'í´ë”' : formatFileSize(file.size)}
                                      </div>
                                    </div>
                                  </div>
                                );
                              })}
                            </div>
                          </div>
                        )}
                        
                        {/* í™•ìž¥ìžë³„ ì„¹ì…˜ */}
                        {Object.entries(groups).map(([ext, files]) => (
                          <div key={ext}>
                            <h3 className="text-lg font-semibold text-gray-900 dark:text-gray-100 mb-4 flex items-center">
                              <DocumentIcon className="w-5 h-5 mr-2 text-blue-500" />
                              {ext === 'no-extension' ? 'í™•ìž¥ìž ì—†ìŒ' : `.${ext.toUpperCase()}`} ({files.length}ê°œ)
                            </h3>
                            <div className={viewMode === 'grid' 
                              ? 'grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-6 xl:grid-cols-8 2xl:grid-cols-10 gap-4' 
                              : viewMode === 'compact'
                              ? 'space-y-1'
                              : 'space-y-2'
                            }>
                              {files.map((file) => {
                                const isSelected = selectedFiles.some(f => f.path === file.path);
                                return viewMode === 'grid' ? (
                                  <div
                                    key={file.path}
                                    className={`group relative p-4 rounded-2xl cursor-pointer transition-all duration-300 hover:scale-105 ${
                                      isSelected 
                                        ? 'bg-blue-50 dark:bg-blue-900/30 border-2 border-blue-500 shadow-lg' 
                                        : 'bg-white/60 dark:bg-gray-800/60 border border-gray-200/50 dark:border-gray-700/50 hover:bg-white dark:hover:bg-gray-800 hover:shadow-xl hover:border-blue-300 dark:hover:border-blue-600'
                                    } backdrop-blur-sm`}
                                    onClick={(e) => handleFileSelect(file, e)}
                                    onDoubleClick={() => handleFileDoubleClick(file)}
                                    onContextMenu={(e) => handleContextMenu(e, file)}
                                  >
                                    <div className="flex flex-col items-center text-center">
                                      <div className="mb-3 transition-all group-hover:scale-110">
                                        {getFileThumbnail(file)}
                                      </div>
                                      <div className="text-sm font-medium text-gray-900 dark:text-gray-100 truncate w-full mb-1">
                                        {file.name}
                                      </div>
                                      <div className="text-xs text-gray-500 dark:text-gray-400">
                                        {file.isDirectory ? 'í´ë”' : formatFileSize(file.size)}
                                      </div>
                                    </div>
                                    <button
                                      onClick={(e) => {
                                        e.stopPropagation();
                                        toggleFavorite(file);
                                      }}
                                      className={`absolute top-2 right-2 w-6 h-6 rounded-full flex items-center justify-center transition-all hover:scale-110 ${
                                        isFavorite(file.path) 
                                          ? 'bg-yellow-500 text-white shadow-lg' 
                                          : 'bg-white/80 dark:bg-gray-800/80 text-gray-400 hover:text-yellow-500 opacity-0 group-hover:opacity-100'
                                      }`}
                                    >
                                      {isFavorite(file.path) ? (
                                        <HeartSolidIcon className="w-4 h-4" />
                                      ) : (
                                        <StarIcon className="w-4 h-4" />
                                      )}
                                    </button>
                                  </div>
                                ) : viewMode === 'compact' ? (
                                  // ì»´íŒ©íŠ¸ ë·° - ê·¸ë£¹ ì„¹ì…˜
                                  <div
                                    key={file.path}
                                    className={`group flex items-center space-x-2 px-3 py-1 rounded-lg cursor-pointer transition-all hover:bg-gray-50 dark:hover:bg-gray-800 ${
                                      isSelected 
                                        ? 'bg-blue-50 dark:bg-blue-900/30 border-l-2 border-blue-500' 
                                        : 'hover:border-l-2 hover:border-gray-300 dark:hover:border-gray-600'
                                    }`}
                                    onClick={(e) => handleFileSelect(file, e)}
                                    onDoubleClick={() => handleFileDoubleClick(file)}
                                    onContextMenu={(e) => handleContextMenu(e, file)}
                                  >
                                    <div className="flex-shrink-0 w-4 h-4">
                                      {React.createElement(getFileIcon(file), { className: "w-4 h-4 text-gray-600 dark:text-gray-400" })}
                                    </div>
                                    <div className="flex-1 min-w-0 text-sm">
                                      <span className="font-medium text-gray-900 dark:text-gray-100 truncate block">
                                        {file.name}
                                      </span>
                                    </div>
                                    <div className="flex-shrink-0 text-xs text-gray-500 dark:text-gray-400 w-20 text-right">
                                      {file.isDirectory ? 'í´ë”' : formatFileSize(file.size)}
                                    </div>
                                    <button
                                      onClick={(e) => {
                                        e.stopPropagation();
                                        toggleFavorite(file);
                                      }}
                                      className={`flex-shrink-0 w-4 h-4 rounded-sm flex items-center justify-center transition-all ${
                                        isFavorite(file.path) 
                                          ? 'text-yellow-500' 
                                          : 'text-gray-300 hover:text-yellow-500 opacity-0 group-hover:opacity-100'
                                      }`}
                                    >
                                      {isFavorite(file.path) ? (
                                        <HeartSolidIcon className="w-3 h-3" />
                                      ) : (
                                        <StarIcon className="w-3 h-3" />
                                      )}
                                    </button>
                                  </div>
                                ) : (
                                  <div key={file.path} className="flex items-center space-x-4 p-3 rounded-2xl">
                                    <div className="flex-shrink-0">
                                      {getFileThumbnail(file)}
                                    </div>
                                    <div className="flex-1 min-w-0">
                                      <div className="text-sm font-medium text-gray-900 dark:text-gray-100 truncate">
                                        {file.name}
                                      </div>
                                      <div className="text-xs text-gray-500 dark:text-gray-400">
                                        {file.isDirectory ? 'í´ë”' : formatFileSize(file.size)}
                                      </div>
                                    </div>
                                  </div>
                                );
                              })}
                            </div>
                          </div>
                        ))}
                      </>
                    );
                  })()}
                </div>
              ) : (
                <div className={
                  viewMode === 'grid' 
                    ? 'grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-6 xl:grid-cols-8 2xl:grid-cols-10 gap-4' 
                    : viewMode === 'compact'
                    ? 'space-y-1'
                    : 'space-y-2'
                }>
                  {filteredFiles.map((file) => {
                    const isSelected = selectedFiles.some(f => f.path === file.path);
                    
                    return viewMode === 'grid' ? (
                      <div
                        key={file.path}
                        className={`group relative p-4 rounded-2xl cursor-pointer transition-all duration-300 hover:scale-105 ${
                          isSelected 
                            ? 'bg-blue-50 dark:bg-blue-900/30 border-2 border-blue-500 shadow-lg' 
                            : 'bg-white/60 dark:bg-gray-800/60 border border-gray-200/50 dark:border-gray-700/50 hover:bg-white dark:hover:bg-gray-800 hover:shadow-xl hover:border-blue-300 dark:hover:border-blue-600'
                        } backdrop-blur-sm`}
                        onClick={(e) => handleFileSelect(file, e)}
                        onDoubleClick={() => handleFileDoubleClick(file)}
                        onContextMenu={(e) => handleContextMenu(e, file)}
                      >
                        <div className="flex flex-col items-center text-center">
                          <div className="mb-3 transition-all group-hover:scale-110">
                            {getFileThumbnail(file)}
                          </div>
                          <div className="text-sm font-medium text-gray-900 dark:text-gray-100 truncate w-full mb-1">
                            {file.name}
                          </div>
                          <div className="text-xs text-gray-500 dark:text-gray-400">
                            {file.isDirectory ? 'í´ë”' : formatFileSize(file.size)}
                          </div>
                        </div>
                        
                        {/* ì¦ê²¨ì°¾ê¸° ë³„í‘œ */}
                        <button
                          onClick={(e) => {
                            e.stopPropagation();
                            toggleFavorite(file);
                          }}
                          className={`absolute top-2 right-2 w-6 h-6 rounded-full flex items-center justify-center transition-all hover:scale-110 ${
                            isFavorite(file.path) 
                              ? 'bg-yellow-500 text-white shadow-lg' 
                              : 'bg-white/80 dark:bg-gray-800/80 text-gray-400 hover:text-yellow-500 opacity-0 group-hover:opacity-100'
                          }`}
                          title={isFavorite(file.path) ? 'ì¦ê²¨ì°¾ê¸°ì—ì„œ ì œê±°' : 'ì¦ê²¨ì°¾ê¸°ì— ì¶”ê°€'}
                        >
                          {isFavorite(file.path) ? (
                            <HeartSolidIcon className="w-4 h-4" />
                          ) : (
                            <StarIcon className="w-4 h-4" />
                          )}
                        </button>
                        
                        {isSelected && (
                          <div className="absolute top-2 left-2 w-5 h-5 bg-blue-500 rounded-full flex items-center justify-center">
                            <svg className="w-3 h-3 text-white" fill="currentColor" viewBox="0 0 20 20">
                              <path fillRule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clipRule="evenodd" />
                            </svg>
                          </div>
                        )}
                      </div>
                    ) : viewMode === 'compact' ? (
                      // ì»´íŒ©íŠ¸ ë·°: ë” ì–‡ê³  ë” ë§Žì´ ë³´ì´ê²Œ
                      <div
                        key={file.path}
                        className={`group flex items-center space-x-2 px-3 py-1 rounded-lg cursor-pointer transition-all hover:bg-gray-50 dark:hover:bg-gray-800 ${
                          isSelected 
                            ? 'bg-blue-50 dark:bg-blue-900/30 border-l-2 border-blue-500' 
                            : 'hover:border-l-2 hover:border-gray-300 dark:hover:border-gray-600'
                        }`}
                        onClick={(e) => handleFileSelect(file, e)}
                        onDoubleClick={() => handleFileDoubleClick(file)}
                        onContextMenu={(e) => handleContextMenu(e, file)}
                      >
                        <div className="flex-shrink-0 w-4 h-4">
                          {React.createElement(getFileIcon(file), { className: "w-4 h-4 text-gray-600 dark:text-gray-400" })}
                        </div>
                        <div className="flex-1 min-w-0 text-sm">
                          <span className="font-medium text-gray-900 dark:text-gray-100 truncate block">
                            {file.name}
                          </span>
                        </div>
                        <div className="flex-shrink-0 text-xs text-gray-500 dark:text-gray-400 w-20 text-right">
                          {file.isDirectory ? 'í´ë”' : formatFileSize(file.size)}
                        </div>
                        
                        {/* ì¦ê²¨ì°¾ê¸° ë³„í‘œ - ì»´íŒ©íŠ¸ */}
                        <button
                          onClick={(e) => {
                            e.stopPropagation();
                            toggleFavorite(file);
                          }}
                          className={`flex-shrink-0 w-4 h-4 rounded-sm flex items-center justify-center transition-all ${
                            isFavorite(file.path) 
                              ? 'text-yellow-500' 
                              : 'text-gray-300 hover:text-yellow-500 opacity-0 group-hover:opacity-100'
                          }`}
                        >
                          {isFavorite(file.path) ? (
                            <HeartSolidIcon className="w-3 h-3" />
                          ) : (
                            <StarIcon className="w-3 h-3" />
                          )}
                        </button>
                        
                        {isSelected && (
                          <div className="flex-shrink-0 w-3 h-3 bg-blue-500 rounded-sm flex items-center justify-center">
                            <svg className="w-2 h-2 text-white" fill="currentColor" viewBox="0 0 20 20">
                              <path fillRule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clipRule="evenodd" />
                            </svg>
                          </div>
                        )}
                      </div>
                    ) : (
                      <div
                        key={file.path}
                        className={`group flex items-center space-x-4 p-4 rounded-2xl cursor-pointer transition-all ${
                          isSelected 
                            ? 'bg-blue-50 dark:bg-blue-900/30 border border-blue-200 dark:border-blue-700' 
                            : 'bg-white/60 dark:bg-gray-800/60 hover:bg-white dark:hover:bg-gray-800 border border-transparent hover:border-gray-200 dark:hover:border-gray-700'
                        } backdrop-blur-sm`}
                        onClick={(e) => handleFileSelect(file, e)}
                        onDoubleClick={() => handleFileDoubleClick(file)}
                        onContextMenu={(e) => handleContextMenu(e, file)}
                      >
                        {getFileThumbnail(file)}
                        <div className="flex-1 min-w-0">
                          <div className="font-medium text-gray-900 dark:text-gray-100 truncate">
                            {file.name}
                          </div>
                          <div className="text-sm text-gray-500 dark:text-gray-400">
                            {formatDate(file.modified)}
                          </div>
                        </div>
                        <div className="text-sm text-gray-500 dark:text-gray-400 font-medium">
                          {file.isDirectory ? 'í´ë”' : formatFileSize(file.size)}
                        </div>
                        
                        {/* ì¦ê²¨ì°¾ê¸° ë³„í‘œ */}
                        <button
                          onClick={(e) => {
                            e.stopPropagation();
                            toggleFavorite(file);
                          }}
                          className={`w-6 h-6 rounded-full flex items-center justify-center transition-all hover:scale-110 ${
                            isFavorite(file.path) 
                              ? 'bg-yellow-500 text-white shadow-lg' 
                              : 'text-gray-400 hover:text-yellow-500 opacity-0 group-hover:opacity-100'
                          }`}
                          title={isFavorite(file.path) ? 'ì¦ê²¨ì°¾ê¸°ì—ì„œ ì œê±°' : 'ì¦ê²¨ì°¾ê¸°ì— ì¶”ê°€'}
                        >
                          {isFavorite(file.path) ? (
                            <HeartSolidIcon className="w-4 h-4" />
                          ) : (
                            <StarIcon className="w-4 h-4" />
                          )}
                        </button>
                        
                        {isSelected && (
                          <div className="w-5 h-5 bg-blue-500 rounded-full flex items-center justify-center">
                            <svg className="w-3 h-3 text-white" fill="currentColor" viewBox="0 0 20 20">
                              <path fillRule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clipRule="evenodd" />
                            </svg>
                          </div>
                        )}
                      </div>
                    );
                  })}
                </div>
              )}
            </div>

            {/* í”„ë¦¬ë¯¸ì—„ ìƒíƒœë°” */}
              </div>
            </main>

          {/* ê°œì„ ëœ ë¯¸ë¦¬ë³´ê¸° íŒ¨ë„ */}
          {preview && (
            <aside className="w-96 bg-white/80 dark:bg-gray-900/80 backdrop-blur-xl border-l border-gray-200/50 dark:border-gray-700/50 flex flex-col">
              <div className="p-6 border-b border-gray-200/50 dark:border-gray-700/50">
                <div className="flex items-center justify-between">
                  <h3 className="text-lg font-bold text-gray-900 dark:text-gray-100 flex items-center">
                    <EyeIcon className="w-5 h-5 mr-2 text-blue-500" />
                    ë¯¸ë¦¬ë³´ê¸°
                  </h3>
                  <button
                    onClick={() => setPreview(null)}
                    className="p-2 rounded-xl hover:bg-gray-100 dark:hover:bg-gray-800 text-gray-400 hover:text-gray-600 dark:hover:text-gray-300 transition-colors"
                  >
                    Ã—
                  </button>
                </div>
              </div>
              
              <div className="flex-1 p-6 overflow-auto">
                <div className="space-y-6">
                  <div className="text-center">
                    <div className="w-16 h-16 mx-auto mb-4 rounded-2xl bg-gradient-to-br from-blue-100 to-purple-100 dark:from-blue-900 dark:to-purple-900 flex items-center justify-center">
                      {React.createElement(getFileIcon(preview), { className: "w-8 h-8 text-blue-600 dark:text-blue-400" })}
                    </div>
                    <h4 className="font-bold text-gray-900 dark:text-gray-100 text-lg mb-2">{preview.name}</h4>
                  </div>
                  
                  <div className="bg-gray-50 dark:bg-gray-800 rounded-2xl p-4 space-y-3">
                    <div className="flex justify-between">
                      <span className="text-gray-600 dark:text-gray-400">í¬ê¸°</span>
                      <span className="font-medium text-gray-900 dark:text-gray-100">{formatFileSize(preview.size)}</span>
                    </div>
                    <div className="flex justify-between">
                      <span className="text-gray-600 dark:text-gray-400">ìˆ˜ì •ì¼</span>
                      <span className="font-medium text-gray-900 dark:text-gray-100">{formatDate(preview.modified)}</span>
                    </div>
                    <div className="flex justify-between">
                      <span className="text-gray-600 dark:text-gray-400">í˜•ì‹</span>
                      <span className="font-medium text-gray-900 dark:text-gray-100">
                        {preview.name.split('.').pop()?.toUpperCase() || 'í´ë”'}
                      </span>
                    </div>
                  </div>
                  
                  {/* í–¥ìƒëœ ë¯¸ë¦¬ë³´ê¸° ì½˜í…ì¸  */}
                  {preview.content && preview.type !== 'error' && (
                    <div>
                      <h5 className="font-bold text-gray-900 dark:text-gray-100 mb-3">ë‚´ìš© ë¯¸ë¦¬ë³´ê¸°</h5>
                      <div className="bg-gray-50 dark:bg-gray-800 rounded-2xl overflow-hidden">
                        {preview.type === 'image' ? (
                          <div className="p-4">
                            <img 
                              src={`file://${preview.fullPath}`} 
                              alt={preview.name}
                              className="w-full h-auto max-h-64 object-contain rounded-xl"
                              onError={(e) => {
                                e.target.style.display = 'none';
                                e.target.nextSibling.style.display = 'block';
                              }}
                            />
                            <div style={{display: 'none'}} className="text-gray-500 text-center py-8">
                              ì´ë¯¸ì§€ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.
                            </div>
                          </div>
                        ) : preview.type === 'video' ? (
                          <div className="p-4">
                            <video 
                              controls 
                              className="w-full h-auto max-h-64 rounded-xl"
                              onError={(e) => {
                                e.target.style.display = 'none';
                                e.target.nextSibling.style.display = 'block';
                              }}
                            >
                              <source src={`file://${preview.fullPath}`} />
                              ë¹„ë””ì˜¤ë¥¼ ì§€ì›í•˜ì§€ ì•ŠëŠ” ë¸Œë¼ìš°ì €ìž…ë‹ˆë‹¤.
                            </video>
                            <div style={{display: 'none'}} className="text-gray-500 text-center py-8">
                              ë™ì˜ìƒì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.
                            </div>
                          </div>
                        ) : preview.type === 'audio' ? (
                          <div className="p-4">
                            <audio 
                              controls 
                              className="w-full"
                              onError={(e) => {
                                e.target.style.display = 'none';
                                e.target.nextSibling.style.display = 'block';
                              }}
                            >
                              <source src={`file://${preview.fullPath}`} />
                              ì˜¤ë””ì˜¤ë¥¼ ì§€ì›í•˜ì§€ ì•ŠëŠ” ë¸Œë¼ìš°ì €ìž…ë‹ˆë‹¤.
                            </audio>
                            <div style={{display: 'none'}} className="text-gray-500 text-center py-8">
                              ì˜¤ë””ì˜¤ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.
                            </div>
                          </div>
                        ) : (
                          <div className="p-4 text-sm font-mono max-h-64 overflow-auto text-gray-700 dark:text-gray-300">
                            {preview.content}
                          </div>
                        )}
                      </div>
                    </div>
                  )}
                  
                  <div className="grid grid-cols-2 gap-3">
                    <button 
                      onClick={() => handleContextMenuAction('share')}
                      className="px-4 py-3 bg-gradient-to-r from-green-500 to-emerald-500 text-white rounded-xl hover:from-green-600 hover:to-emerald-600 font-medium transition-all shadow-lg hover:shadow-xl flex items-center justify-center space-x-2"
                    >
                      <PaperAirplaneIcon className="w-4 h-4" />
                      <span>ê³µìœ </span>
                    </button>
                    <button className="px-4 py-3 bg-gradient-to-r from-blue-500 to-purple-500 text-white rounded-xl hover:from-blue-600 hover:to-purple-600 font-medium transition-all shadow-lg hover:shadow-xl">
                      AI ë¶„ì„
                    </button>
                  </div>
                </div>
              </div>
            </aside>
          )}
        </div>

        {/* ìš°ì¸¡ ì»¨í…ìŠ¤íŠ¸ ë©”ë‰´ - AI ë¶„ì„ ë° ì•¡ì…˜ */}
        {contextMenu.show && (
          <div
            className="fixed z-50 bg-white/95 dark:bg-gray-900/95 backdrop-blur-xl border border-gray-200/50 dark:border-gray-700/50 rounded-3xl shadow-2xl py-4 min-w-[300px]"
            style={{ left: contextMenu.x, top: contextMenu.y }}
          >
            {/* íŒŒì¼ ì •ë³´ í—¤ë” */}
            <div className="px-6 pb-4 border-b border-gray-200/50 dark:border-gray-700/50">
              <div className="flex items-center space-x-3">
                <div className="w-12 h-12 rounded-xl bg-gradient-to-br from-blue-500 to-purple-500 flex items-center justify-center">
                  {getFileIcon(contextMenu.target)}
                </div>
                <div className="flex-1">
                  <h3 className="font-bold text-gray-900 dark:text-gray-100 truncate">{contextMenu.target?.name}</h3>
                  <p className="text-sm text-gray-500 dark:text-gray-400">
                    {contextMenu.target?.isDirectory ? 'í´ë”' : formatFileSize(contextMenu.target?.size)}
                  </p>
                </div>
              </div>
            </div>

            {/* AI ë¶„ì„ ì„¹ì…˜ */}
            <div className="px-6 py-4 border-b border-gray-200/50 dark:border-gray-700/50">
              <h4 className="text-sm font-bold text-gray-900 dark:text-gray-100 mb-3 flex items-center">
                <SparklesIcon className="w-4 h-4 mr-2 text-purple-500" />
                AI ë¶„ì„
              </h4>
              <div className="grid grid-cols-2 gap-2">
                <button
                  onClick={() => handleContextMenuAction('ai-summary')}
                  className="flex items-center space-x-2 p-2 rounded-lg hover:bg-purple-50 dark:hover:bg-purple-900/20 transition-colors text-left"
                >
                  <DocumentTextIcon className="w-4 h-4 text-purple-500" />
                  <span className="text-xs font-medium text-gray-700 dark:text-gray-300">ìš”ì•½</span>
                </button>
                <button
                  onClick={() => handleContextMenuAction('ai-analysis')}
                  className="flex items-center space-x-2 p-2 rounded-lg hover:bg-purple-50 dark:hover:bg-purple-900/20 transition-colors text-left"
                >
                  <BeakerIcon className="w-4 h-4 text-purple-500" />
                  <span className="text-xs font-medium text-gray-700 dark:text-gray-300">ë¶„ì„</span>
                </button>
              </div>
            </div>

            {/* ê¸°ë³¸ ì•¡ì…˜ */}
            <div className="px-6 py-2">
              {[
                { action: 'preview', icon: EyeIcon, label: 'ë¯¸ë¦¬ë³´ê¸°', color: 'text-blue-500' },
                { action: 'edit', icon: PencilIcon, label: 'íŽ¸ì§‘', color: 'text-green-500' },
                { action: 'share', icon: PaperAirplaneIcon, label: 'ë©”ì‹ ì €ë¡œ ê³µìœ ', color: 'text-emerald-500' },
                { action: 'copy', icon: DocumentDuplicateIcon, label: 'ë³µì‚¬', color: 'text-orange-500' },
                { action: 'delete', icon: TrashIcon, label: 'ì‚­ì œ', color: 'text-red-500' }
              ].map(({ action, icon: Icon, label, color }) => (
                <button 
                  key={action}
                  className="w-full px-3 py-2.5 text-left hover:bg-gray-50 dark:hover:bg-gray-800 text-sm flex items-center space-x-3 transition-colors rounded-lg"
                  onClick={() => handleContextMenuAction(action)}
                >
                  <Icon className={`w-4 h-4 ${color}`} />
                  <span className="font-medium text-gray-700 dark:text-gray-300">{label}</span>
                </button>
              ))}
            </div>
          </div>
        )}

        {/* ì‚¬ë‚´ ë©”ì‹ ì € íŒ¨ë„ */}
        {messengerExpanded && (
          <div className="fixed bottom-6 left-6 w-96 bg-white/90 dark:bg-gray-900/90 backdrop-blur-xl rounded-3xl shadow-2xl border border-gray-200/50 dark:border-gray-700/50 overflow-hidden">
            <div className="p-6 bg-gradient-to-r from-green-600 to-emerald-600">
              <div className="flex items-center justify-between">
                <div className="flex items-center space-x-3">
                  <div className="w-10 h-10 bg-white/20 rounded-2xl flex items-center justify-center">
                    <ChatSolidIcon className="w-6 h-6 text-white" />
                  </div>
                  <div>
                    <h3 className="font-bold text-white">íŒ€ ë©”ì‹ ì €</h3>
                    <p className="text-xs text-white/80">{onlineUsers.filter(u => u.status === 'online').length}ëª… ì˜¨ë¼ì¸</p>
                  </div>
                </div>
                <button
                  onClick={() => setMessengerExpanded(false)}
                  className="p-2 rounded-xl hover:bg-white/20 text-white transition-colors"
                >
                  Ã—
                </button>
              </div>
            </div>

            {/* ì˜¨ë¼ì¸ ì‚¬ìš©ìž ëª©ë¡ */}
            <div className="px-6 py-4 border-b border-gray-200/50 dark:border-gray-700/50">
              <h4 className="text-sm font-bold text-gray-900 dark:text-gray-100 mb-3">ì˜¨ë¼ì¸ ì‚¬ìš©ìž</h4>
              <div className="flex space-x-2">
                {onlineUsers.map((user) => (
                  <div key={user.id} className="flex items-center space-x-2">
                    <div className="relative">
                      <span className="text-2xl">{user.avatar}</span>
                      <div className={`absolute -bottom-1 -right-1 w-3 h-3 rounded-full border-2 border-white ${
                        user.status === 'online' ? 'bg-green-500' : 
                        user.status === 'away' ? 'bg-yellow-500' : 'bg-gray-500'
                      }`}></div>
                    </div>
                  </div>
                ))}
              </div>
            </div>
            
            {/* ë©”ì‹œì§€ ì˜ì—­ */}
            <div className="h-80 overflow-auto p-6 space-y-4">
              {messages.length === 0 ? (
                <div className="text-center py-8">
                  <div className="w-16 h-16 mx-auto mb-4 bg-gradient-to-br from-green-100 to-emerald-100 dark:from-green-900 dark:to-emerald-900 rounded-2xl flex items-center justify-center">
                    <UserGroupIcon className="w-8 h-8 text-green-600 dark:text-green-400" />
                  </div>
                  <p className="text-gray-600 dark:text-gray-400 mb-2">íŒ€ì›ë“¤ê³¼ ëŒ€í™”ë¥¼ ì‹œìž‘í•˜ì„¸ìš”!</p>
                  <p className="text-xs text-gray-500 dark:text-gray-500">íŒŒì¼ì„ ìš°í´ë¦­í•´ì„œ ê³µìœ í•  ìˆ˜ë„ ìžˆì–´ìš”</p>
                </div>
              ) : (
                messages.map((msg) => (
                  <div key={msg.id} className={`flex ${msg.sender === 'ë‚˜' ? 'justify-end' : 'justify-start'}`}>
                    <div className="max-w-xs">
                      {msg.sender !== 'ë‚˜' && (
                        <div className="flex items-center space-x-2 mb-1">
                          <span className="text-lg">{msg.avatar}</span>
                          <span className="text-xs text-gray-500 dark:text-gray-400">{msg.sender}</span>
                        </div>
                      )}
                      <div className={`px-4 py-3 rounded-2xl ${
                        msg.sender === 'ë‚˜' 
                          ? 'bg-gradient-to-r from-green-500 to-emerald-500 text-white' 
                          : 'bg-gray-100 dark:bg-gray-800 text-gray-900 dark:text-gray-100'
                      }`}>
                        {msg.type === 'file' ? (
                          <div className="flex items-center space-x-2">
                            <DocumentIcon className="w-4 h-4" />
                            <span className="text-sm font-medium">{msg.file?.name}</span>
                          </div>
                        ) : (
                          <p className="text-sm">{msg.content}</p>
                        )}
                      </div>
                      <div className="text-xs text-gray-500 dark:text-gray-400 mt-1 px-2">
                        {msg.timestamp.toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit' })}
                      </div>
                    </div>
                  </div>
                ))
              )}
            </div>
            
            {/* ë©”ì‹œì§€ ìž…ë ¥ */}
            <div className="p-6 border-t border-gray-200/50 dark:border-gray-700/50">
              <div className="flex space-x-3">
                <input
                  type="text"
                  value={messengerInput}
                  onChange={(e) => setMessengerInput(e.target.value)}
                  placeholder="ë©”ì‹œì§€ë¥¼ ìž…ë ¥í•˜ì„¸ìš”..."
                  className="flex-1 px-4 py-3 bg-gray-50 dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-2xl focus:ring-2 focus:ring-green-500 focus:border-transparent text-sm text-gray-900 dark:text-gray-100 placeholder-gray-500 dark:placeholder-gray-400"
                  onKeyPress={(e) => e.key === 'Enter' && handleSendMessage()}
                />
                <button
                  onClick={handleSendMessage}
                  disabled={!messengerInput.trim()}
                  className="px-6 py-3 bg-gradient-to-r from-green-500 to-emerald-500 text-white rounded-2xl hover:from-green-600 hover:to-emerald-600 disabled:opacity-50 disabled:cursor-not-allowed font-medium transition-all shadow-lg hover:shadow-xl"
                >
                  ì „ì†¡
                </button>
              </div>
            </div>
          </div>
        )}

        {/* AI ì±„íŒ… íŒ¨ë„ */}
        {aiChatExpanded && (
          <div className="fixed bottom-6 right-6 w-96 bg-white/90 dark:bg-gray-900/90 backdrop-blur-xl rounded-3xl shadow-2xl border border-gray-200/50 dark:border-gray-700/50 overflow-hidden">
            <div className="p-6 bg-gradient-to-r from-purple-600 to-blue-600">
              <div className="flex items-center justify-between">
                <div className="flex items-center space-x-3">
                  <div className="w-10 h-10 bg-white/20 rounded-2xl flex items-center justify-center">
                    <SparklesSolidIcon className="w-6 h-6 text-white" />
                  </div>
                  <div>
                    <h3 className="font-bold text-white">AI ì½”íŒŒì¼ëŸ¿</h3>
                    <p className="text-xs text-white/80">íŒŒì¼ ê´€ë¦¬ë¥¼ ë„ì™€ë“œë¦½ë‹ˆë‹¤</p>
                  </div>
                </div>
                <button
                  onClick={() => setAiChatExpanded(false)}
                  className="p-2 rounded-xl hover:bg-white/20 text-white transition-colors"
                >
                  Ã—
                </button>
              </div>
            </div>
            
            <div className="h-80 overflow-auto p-6 space-y-4">
              {chatHistory.length === 0 ? (
                <div className="text-center py-8">
                  <div className="w-16 h-16 mx-auto mb-4 bg-gradient-to-br from-purple-100 to-blue-100 dark:from-purple-900 dark:to-blue-900 rounded-2xl flex items-center justify-center">
                    <SparklesIcon className="w-8 h-8 text-purple-600 dark:text-purple-400" />
                  </div>
                  <p className="text-gray-600 dark:text-gray-400 mb-4">ê³ ê¸‰ AI ì½”íŒŒì¼ëŸ¿ì´ íŒŒì¼ ê´€ë¦¬ë¥¼ ë„ì™€ë“œë¦½ë‹ˆë‹¤!</p>
                  <div className="grid grid-cols-1 gap-2 max-w-xs mx-auto text-xs">
                    <div className="p-3 bg-gradient-to-r from-blue-50 to-purple-50 dark:from-blue-900/30 dark:to-purple-900/30 rounded-xl">
                      <p className="font-semibold text-blue-700 dark:text-blue-300">íŒŒì¼ ê²€ìƒ‰</p>
                      <p className="text-blue-600 dark:text-blue-400">"ìµœê·¼ ì‚¬ì§„ì„ ì°¾ì•„ì¤˜"</p>
                    </div>
                    <div className="p-3 bg-gradient-to-r from-green-50 to-emerald-50 dark:from-green-900/30 dark:to-emerald-900/30 rounded-xl">
                      <p className="font-semibold text-green-700 dark:text-green-300">íŒŒì¼ ì •ë¦¬</p>
                      <p className="text-green-600 dark:text-green-400">"íŒŒì¼ë“¤ì„ íƒ€ìž…ë³„ë¡œ ì •ë¦¬í•´ì¤˜"</p>
                    </div>
                    <div className="p-3 bg-gradient-to-r from-orange-50 to-red-50 dark:from-orange-900/30 dark:to-red-900/30 rounded-xl">
                      <p className="font-semibold text-orange-700 dark:text-orange-300">ë‚´ìš© ë¶„ì„</p>
                      <p className="text-orange-600 dark:text-orange-400">"ì´ ë¬¸ì„œë¥¼ ìš”ì•½í•´ì¤˜"</p>
                    </div>
                    <div className="p-3 bg-gradient-to-r from-purple-50 to-pink-50 dark:from-purple-900/30 dark:to-pink-900/30 rounded-xl">
                      <p className="font-semibold text-purple-700 dark:text-purple-300">ìœ„ì¹˜ ì•ˆë‚´</p>
                      <p className="text-purple-600 dark:text-purple-400">"í”„ë¡œì íŠ¸ í´ë”ê°€ ì–´ë””ì— ìžˆì–´?"</p>
                    </div>
                  </div>
                </div>
              ) : (
                chatHistory.map((msg, index) => (
                  <div key={index} className={`flex ${msg.role === 'user' ? 'justify-end' : 'justify-start'}`}>
                    <div className={`max-w-xs px-4 py-3 rounded-2xl whitespace-pre-wrap ${
                      msg.role === 'user' 
                        ? 'bg-gradient-to-r from-blue-500 to-purple-500 text-white' 
                        : 'bg-gray-100 dark:bg-gray-800 text-gray-900 dark:text-gray-100'
                    }`}>
                      <p className="text-sm">{msg.content}</p>
                      {msg.actions && msg.actions.length > 0 && (
                        <div className="mt-2 pt-2 border-t border-gray-200 dark:border-gray-600">
                          <p className="text-xs opacity-75">ì‹¤í–‰ëœ ì•¡ì…˜: {msg.actions.length}ê°œ</p>
                        </div>
                      )}
                    </div>
                  </div>
                ))
              )}
              
              {/* AI ì‚¬ê³  ì¤‘ í‘œì‹œ */}
              {aiThinking && (
                <div className="flex justify-start">
                  <div className="max-w-xs px-4 py-3 rounded-2xl bg-gray-100 dark:bg-gray-800 text-gray-900 dark:text-gray-100">
                    <div className="flex items-center space-x-2">
                      <div className="flex space-x-1">
                        <div className="w-2 h-2 bg-purple-500 rounded-full animate-bounce"></div>
                        <div className="w-2 h-2 bg-purple-500 rounded-full animate-bounce" style={{animationDelay: '0.1s'}}></div>
                        <div className="w-2 h-2 bg-purple-500 rounded-full animate-bounce" style={{animationDelay: '0.2s'}}></div>
                      </div>
                      <span className="text-sm text-purple-600 dark:text-purple-400">ì‚¬ê³  ì¤‘...</span>
                    </div>
                  </div>
                </div>
              )}
              
              {/* AI ì œì•ˆì‚¬í•­ */}
              {aiSuggestions.length > 0 && (
                <div className="border-t border-gray-200 dark:border-gray-700 pt-4">
                  <p className="text-xs font-semibold text-gray-500 dark:text-gray-400 mb-2">ì¶”ì²œ ì§ˆë¬¸:</p>
                  <div className="space-y-2">
                    {aiSuggestions.slice(0, 3).map((suggestion, index) => (
                      <button
                        key={index}
                        onClick={() => {
                          setChatInput(suggestion);
                          setAiSuggestions([]);
                        }}
                        className="w-full text-left p-2 rounded-lg bg-purple-50 dark:bg-purple-900/20 hover:bg-purple-100 dark:hover:bg-purple-900/40 text-xs text-purple-700 dark:text-purple-300 transition-colors"
                      >
                        {suggestion}
                      </button>
                    ))}
                  </div>
                </div>
              )}
            </div>
            
            <div className="p-6 border-t border-gray-200/50 dark:border-gray-700/50">
              <div className="flex space-x-3">
                <input
                  type="text"
                  value={chatInput}
                  onChange={(e) => setChatInput(e.target.value)}
                  placeholder="ìžì—°ì–´ë¡œ íŒŒì¼ ê´€ë¦¬ë¥¼ ìš”ì²­í•˜ì„¸ìš”... (ì˜ˆ: 'ì‚¬ì§„ íŒŒì¼ë“¤ì„ ì •ë¦¬í•´ì¤˜', 'ìµœê·¼ ë¬¸ì„œë¥¼ ì°¾ì•„ì¤˜')"
                  className="flex-1 px-4 py-3 bg-gray-50 dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-2xl focus:ring-2 focus:ring-purple-500 focus:border-transparent text-sm text-gray-900 dark:text-gray-100 placeholder-gray-500 dark:placeholder-gray-400"
                  onKeyPress={(e) => e.key === 'Enter' && handleSendChat()}
                />
                <button
                  onClick={handleSendChat}
                  disabled={!chatInput.trim()}
                  className="px-6 py-3 bg-gradient-to-r from-purple-500 to-blue-500 text-white rounded-2xl hover:from-purple-600 hover:to-blue-600 disabled:opacity-50 disabled:cursor-not-allowed font-medium transition-all shadow-lg hover:shadow-xl"
                >
                  ì „ì†¡
                </button>
              </div>
            </div>
          </div>
        )}

        {/* ê³ ê¸‰ ê²€ìƒ‰ íŒ¨ë„ */}
        {advancedSearchOpen && (
          <div className="fixed inset-0 bg-black/50 backdrop-blur-sm z-60 flex items-center justify-center">
            <div className="bg-white/95 dark:bg-gray-900/95 backdrop-blur-xl rounded-3xl shadow-2xl border border-gray-200/50 dark:border-gray-700/50 w-96 max-h-[80vh] overflow-auto">
              <div className="p-6 border-b border-gray-200/50 dark:border-gray-700/50">
                <div className="flex items-center justify-between">
                  <h3 className="text-xl font-bold text-gray-900 dark:text-gray-100 flex items-center">
                    <MagnifyingGlassIcon className="w-6 h-6 mr-2 text-green-500" />
                    ê³ ê¸‰ ê²€ìƒ‰
                  </h3>
                  <button
                    onClick={() => setAdvancedSearchOpen(false)}
                    className="p-2 rounded-xl hover:bg-gray-100 dark:hover:bg-gray-800 text-gray-400 hover:text-gray-600 dark:hover:text-gray-300"
                  >
                    Ã—
                  </button>
                </div>
              </div>
              
              <div className="p-6 space-y-4">
                <div>
                  <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                    íŒŒì¼ëª… ê²€ìƒ‰
                  </label>
                  <input
                    type="text"
                    value={searchParams.filename}
                    onChange={(e) => setSearchParams(prev => ({ ...prev, filename: e.target.value }))}
                    placeholder="íŒŒì¼ëª…ì„ ìž…ë ¥í•˜ì„¸ìš”..."
                    className="w-full px-4 py-3 rounded-xl border border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800 text-gray-900 dark:text-gray-100 focus:ring-2 focus:ring-green-500 focus:border-transparent"
                  />
                </div>
                
                <div>
                  <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                    íŒŒì¼ í™•ìž¥ìž
                  </label>
                  <div className="grid grid-cols-3 gap-2">
                    {['jpg', 'pdf', 'docx', 'mp4', 'txt', 'zip'].map(ext => (
                      <button
                        key={ext}
                        onClick={() => {
                          setSearchParams(prev => ({
                            ...prev,
                            extensions: prev.extensions.includes(ext)
                              ? prev.extensions.filter(e => e !== ext)
                              : [...prev.extensions, ext]
                          }));
                        }}
                        className={`px-3 py-2 rounded-lg border text-sm transition-colors ${
                          searchParams.extensions.includes(ext)
                            ? 'bg-green-100 border-green-300 text-green-800 dark:bg-green-900/20 dark:border-green-600 dark:text-green-400'
                            : 'border-gray-200 dark:border-gray-700 hover:bg-green-50 dark:hover:bg-green-900/20 hover:border-green-300 dark:hover:border-green-600'
                        }`}
                      >
                        .{ext}
                      </button>
                    ))}
                  </div>
                </div>
                
                <div className="grid grid-cols-2 gap-4">
                  <div>
                    <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                      ìµœì†Œ í¬ê¸°
                    </label>
                    <select 
                      value={searchParams.minSize}
                      onChange={(e) => setSearchParams(prev => ({ ...prev, minSize: e.target.value }))}
                      className="w-full px-3 py-2 rounded-lg border border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800 text-gray-900 dark:text-gray-100"
                    >
                      <option value="">ì œí•œ ì—†ìŒ</option>
                      <option value="1024">1KB</option>
                      <option value="1048576">1MB</option>
                      <option value="10485760">10MB</option>
                      <option value="104857600">100MB</option>
                    </select>
                  </div>
                  <div>
                    <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                      ìµœëŒ€ í¬ê¸°
                    </label>
                    <select 
                      value={searchParams.maxSize}
                      onChange={(e) => setSearchParams(prev => ({ ...prev, maxSize: e.target.value }))}
                      className="w-full px-3 py-2 rounded-lg border border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800 text-gray-900 dark:text-gray-100"
                    >
                      <option value="">ì œí•œ ì—†ìŒ</option>
                      <option value="1048576">1MB</option>
                      <option value="10485760">10MB</option>
                      <option value="104857600">100MB</option>
                      <option value="1073741824">1GB</option>
                    </select>
                  </div>
                </div>
                
                <div>
                  <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                    ìˆ˜ì • ë‚ ì§œ
                  </label>
                  <div className="grid grid-cols-2 gap-2">
                    <input 
                      type="date" 
                      value={searchParams.startDate}
                      onChange={(e) => setSearchParams(prev => ({ ...prev, startDate: e.target.value }))}
                      className="px-3 py-2 rounded-lg border border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800 text-gray-900 dark:text-gray-100" 
                    />
                    <input 
                      type="date" 
                      value={searchParams.endDate}
                      onChange={(e) => setSearchParams(prev => ({ ...prev, endDate: e.target.value }))}
                      className="px-3 py-2 rounded-lg border border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800 text-gray-900 dark:text-gray-100" 
                    />
                  </div>
                </div>
                
                <button 
                  onClick={handleAdvancedSearch}
                  disabled={searchLoading}
                  className="w-full px-6 py-3 bg-gradient-to-r from-green-500 to-emerald-500 text-white rounded-xl font-medium hover:from-green-600 hover:to-emerald-600 transition-all shadow-lg hover:shadow-xl disabled:opacity-50 disabled:cursor-not-allowed"
                >
                  {searchLoading ? 'ê²€ìƒ‰ ì¤‘...' : 'ê²€ìƒ‰ ì‹¤í–‰'}
                </button>
              </div>
            </div>
          </div>
        )}

        {/* ë°±ì—… ê´€ë¦¬ íŒ¨ë„ */}
        {backupPanelOpen && (
          <div className="fixed inset-0 bg-black/50 backdrop-blur-sm z-60 flex items-center justify-center">
            <div className="bg-white/95 dark:bg-gray-900/95 backdrop-blur-xl rounded-3xl shadow-2xl border border-gray-200/50 dark:border-gray-700/50 w-[32rem] max-h-[80vh] overflow-auto">
              <div className="p-6 border-b border-gray-200/50 dark:border-gray-700/50">
                <div className="flex items-center justify-between">
                  <h3 className="text-xl font-bold text-gray-900 dark:text-gray-100 flex items-center">
                    <CloudIcon className="w-6 h-6 mr-2 text-purple-500" />
                    ë°±ì—… ê´€ë¦¬
                  </h3>
                  <button
                    onClick={() => setBackupPanelOpen(false)}
                    className="p-2 rounded-xl hover:bg-gray-100 dark:hover:bg-gray-800 text-gray-400 hover:text-gray-600 dark:hover:text-gray-300"
                  >
                    Ã—
                  </button>
                </div>
              </div>
              
              <div className="p-6 space-y-6">
                <div className="grid grid-cols-2 gap-4">
                  <button 
                    onClick={handleCreateBackup}
                    className="p-4 rounded-xl border border-gray-200 dark:border-gray-700 hover:bg-purple-50 dark:hover:bg-purple-900/20 transition-colors"
                  >
                    <CloudIcon className="w-8 h-8 text-purple-500 mx-auto mb-2" />
                    <div className="text-sm font-medium text-gray-900 dark:text-gray-100">ìƒˆ ë°±ì—… ìƒì„±</div>
                  </button>
                  <button 
                    onClick={handleRestoreBackup}
                    className="p-4 rounded-xl border border-gray-200 dark:border-gray-700 hover:bg-blue-50 dark:hover:bg-blue-900/20 transition-colors"
                  >
                    <ArrowPathIcon className="w-8 h-8 text-blue-500 mx-auto mb-2" />
                    <div className="text-sm font-medium text-gray-900 dark:text-gray-100">ë°±ì—… ë³µì›</div>
                  </button>
                </div>
                
                <div>
                  <h4 className="font-semibold text-gray-900 dark:text-gray-100 mb-3">ë°±ì—… ížˆìŠ¤í† ë¦¬</h4>
                  <div className="space-y-2">
                    <div className="p-3 rounded-lg border border-gray-200 dark:border-gray-700 flex items-center justify-between">
                      <div>
                        <div className="font-medium text-gray-900 dark:text-gray-100">ì „ì²´ ì‹œìŠ¤í…œ ë°±ì—…</div>
                        <div className="text-xs text-gray-500 dark:text-gray-400">2024-01-15 14:30</div>
                      </div>
                      <div className="text-sm text-green-600 dark:text-green-400">ì™„ë£Œ</div>
                    </div>
                  </div>
                </div>
                
                <div>
                  <h4 className="font-semibold text-gray-900 dark:text-gray-100 mb-3">ìžë™ ë°±ì—… ì„¤ì •</h4>
                  <div className="space-y-3">
                    <div className="flex items-center justify-between">
                      <span className="text-gray-700 dark:text-gray-300">ìžë™ ë°±ì—… í™œì„±í™”</span>
                      <button className="w-12 h-6 bg-purple-500 rounded-full relative">
                        <div className="w-5 h-5 bg-white rounded-full absolute right-0.5 top-0.5"></div>
                      </button>
                    </div>
                    <select className="w-full px-3 py-2 rounded-lg border border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800 text-gray-900 dark:text-gray-100">
                      <option>ë§¤ì¼</option>
                      <option>ë§¤ì£¼</option>
                      <option>ë§¤ì›”</option>
                    </select>
                  </div>
                </div>
              </div>
            </div>
          </div>
        )}

        {/* ë³´ì•ˆ ê´€ë¦¬ íŒ¨ë„ */}
        {securityPanelOpen && (
          <div className="fixed inset-0 bg-black/50 backdrop-blur-sm z-60 flex items-center justify-center">
            <div className="bg-white/95 dark:bg-gray-900/95 backdrop-blur-xl rounded-3xl shadow-2xl border border-gray-200/50 dark:border-gray-700/50 w-[32rem] max-h-[80vh] overflow-auto">
              <div className="p-6 border-b border-gray-200/50 dark:border-gray-700/50">
                <div className="flex items-center justify-between">
                  <h3 className="text-xl font-bold text-gray-900 dark:text-gray-100 flex items-center">
                    <ShieldCheckIcon className="w-6 h-6 mr-2 text-red-500" />
                    ë³´ì•ˆ ê´€ë¦¬
                  </h3>
                  <button
                    onClick={() => setSecurityPanelOpen(false)}
                    className="p-2 rounded-xl hover:bg-gray-100 dark:hover:bg-gray-800 text-gray-400 hover:text-gray-600 dark:hover:text-gray-300"
                  >
                    Ã—
                  </button>
                </div>
              </div>
              
              <div className="p-6 space-y-6">
                <div className="grid grid-cols-2 gap-4">
                  <button 
                    onClick={() => selectedFiles.length > 0 && handleEncryptFile(selectedFiles[0].path)}
                    className="p-4 rounded-xl border border-gray-200 dark:border-gray-700 hover:bg-red-50 dark:hover:bg-red-900/20 transition-colors"
                  >
                    <ShieldCheckIcon className="w-8 h-8 text-red-500 mx-auto mb-2" />
                    <div className="text-sm font-medium text-gray-900 dark:text-gray-100">íŒŒì¼ ì•”í˜¸í™”</div>
                  </button>
                  <button 
                    onClick={loadEncryptedFiles}
                    className="p-4 rounded-xl border border-gray-200 dark:border-gray-700 hover:bg-green-50 dark:hover:bg-green-900/20 transition-colors"
                  >
                    <LightBulbIcon className="w-8 h-8 text-green-500 mx-auto mb-2" />
                    <div className="text-sm font-medium text-gray-900 dark:text-gray-100">ì•”í˜¸í™” íŒŒì¼ ëª©ë¡</div>
                  </button>
                </div>
                
                <div>
                  <h4 className="font-semibold text-gray-900 dark:text-gray-100 mb-3">ì•”í˜¸í™”ëœ íŒŒì¼</h4>
                  <div className="space-y-2 max-h-40 overflow-y-auto">
                    {encryptedFiles.length === 0 ? (
                      <div className="text-center py-4 text-gray-500 dark:text-gray-400 text-sm">
                        ì•”í˜¸í™”ëœ íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤.
                      </div>
                    ) : (
                      encryptedFiles.map((file, index) => (
                        <div key={index} className="p-3 rounded-lg border border-gray-200 dark:border-gray-700 flex items-center justify-between">
                          <div>
                            <div className="font-medium text-gray-900 dark:text-gray-100">{file.name}</div>
                            <div className="text-xs text-gray-500 dark:text-gray-400">{file.path}</div>
                          </div>
                          <button 
                            onClick={() => handleDecryptFile(file.path)}
                            className="px-3 py-1 bg-red-500 text-white rounded-lg text-xs hover:bg-red-600 transition-colors"
                          >
                            ë³µí˜¸í™”
                          </button>
                        </div>
                      ))
                    )}
                  </div>
                </div>
              </div>
            </div>
          </div>
        )}

        {/* ìµœì í™” íŒ¨ë„ */}
        {optimizePanelOpen && (
          <div className="fixed inset-0 bg-black/50 backdrop-blur-sm z-60 flex items-center justify-center">
            <div className="bg-white/95 dark:bg-gray-900/95 backdrop-blur-xl rounded-3xl shadow-2xl border border-gray-200/50 dark:border-gray-700/50 w-[32rem] max-h-[80vh] overflow-auto">
              <div className="p-6 border-b border-gray-200/50 dark:border-gray-700/50">
                <div className="flex items-center justify-between">
                  <h3 className="text-xl font-bold text-gray-900 dark:text-gray-100 flex items-center">
                    <BoltIcon className="w-6 h-6 mr-2 text-yellow-500" />
                    ì‹œìŠ¤í…œ ìµœì í™”
                  </h3>
                  <button
                    onClick={() => setOptimizePanelOpen(false)}
                    className="p-2 rounded-xl hover:bg-gray-100 dark:hover:bg-gray-800 text-gray-400 hover:text-gray-600 dark:hover:text-gray-300"
                  >
                    Ã—
                  </button>
                </div>
              </div>
              
              <div className="p-6 space-y-6">
                <div className="grid grid-cols-2 gap-4">
                  <button 
                    onClick={loadOptimizeData}
                    className="p-4 rounded-xl border border-gray-200 dark:border-gray-700 hover:bg-yellow-50 dark:hover:bg-yellow-900/20 transition-colors"
                  >
                    <DocumentDuplicateIcon className="w-8 h-8 text-yellow-500 mx-auto mb-2" />
                    <div className="text-sm font-medium text-gray-900 dark:text-gray-100">ì¤‘ë³µ íŒŒì¼ ê²€ìƒ‰</div>
                  </button>
                  <button className="p-4 rounded-xl border border-gray-200 dark:border-gray-700 hover:bg-orange-50 dark:hover:bg-orange-900/20 transition-colors">
                    <TrashIcon className="w-8 h-8 text-orange-500 mx-auto mb-2" />
                    <div className="text-sm font-medium text-gray-900 dark:text-gray-100">ìž„ì‹œ íŒŒì¼ ì •ë¦¬</div>
                  </button>
                </div>
                
                <div>
                  <h4 className="font-semibold text-gray-900 dark:text-gray-100 mb-3">ì¤‘ë³µ íŒŒì¼ ({duplicateFiles.length}ê°œ)</h4>
                  <div className="space-y-2 max-h-40 overflow-y-auto">
                    {duplicateFiles.length === 0 ? (
                      <div className="text-center py-4 text-gray-500 dark:text-gray-400 text-sm">
                        ì¤‘ë³µ íŒŒì¼ì„ ê²€ìƒ‰í•˜ë ¤ë©´ ìœ„ ë²„íŠ¼ì„ í´ë¦­í•˜ì„¸ìš”.
                      </div>
                    ) : (
                      duplicateFiles.map((file, index) => (
                        <div key={index} className="p-3 rounded-lg border border-gray-200 dark:border-gray-700">
                          <div className="font-medium text-gray-900 dark:text-gray-100">{file.name}</div>
                          <div className="text-xs text-gray-500 dark:text-gray-400">{formatFileSize(file.size)} â€¢ {file.duplicates}ê°œ ì¤‘ë³µ</div>
                        </div>
                      ))
                    )}
                  </div>
                </div>
              </div>
            </div>
          </div>
        )}

        {/* í´ë¼ìš°ë“œ ì—°ë™ íŒ¨ë„ */}
        {cloudPanelOpen && (
          <div className="fixed inset-0 bg-black/50 backdrop-blur-sm z-60 flex items-center justify-center">
            <div className="bg-white/95 dark:bg-gray-900/95 backdrop-blur-xl rounded-3xl shadow-2xl border border-gray-200/50 dark:border-gray-700/50 w-[32rem] max-h-[80vh] overflow-auto">
              <div className="p-6 border-b border-gray-200/50 dark:border-gray-700/50">
                <div className="flex items-center justify-between">
                  <h3 className="text-xl font-bold text-gray-900 dark:text-gray-100 flex items-center">
                    <GlobeAltIcon className="w-6 h-6 mr-2 text-indigo-500" />
                    í´ë¼ìš°ë“œ ìŠ¤í† ë¦¬ì§€
                  </h3>
                  <button
                    onClick={() => setCloudPanelOpen(false)}
                    className="p-2 rounded-xl hover:bg-gray-100 dark:hover:bg-gray-800 text-gray-400 hover:text-gray-600 dark:hover:text-gray-300"
                  >
                    Ã—
                  </button>
                </div>
              </div>
              
              <div className="p-6 space-y-6">
                <div className="grid grid-cols-3 gap-4">
                  <button 
                    onClick={() => handleCloudSync('googledrive')}
                    className="p-4 rounded-xl border border-gray-200 dark:border-gray-700 hover:bg-blue-50 dark:hover:bg-blue-900/20 transition-colors"
                  >
                    <CloudIcon className="w-8 h-8 text-blue-500 mx-auto mb-2" />
                    <div className="text-xs font-medium text-gray-900 dark:text-gray-100">Google Drive</div>
                  </button>
                  <button 
                    onClick={() => handleCloudSync('aws')}
                    className="p-4 rounded-xl border border-gray-200 dark:border-gray-700 hover:bg-orange-50 dark:hover:bg-orange-900/20 transition-colors"
                  >
                    <CloudIcon className="w-8 h-8 text-orange-500 mx-auto mb-2" />
                    <div className="text-xs font-medium text-gray-900 dark:text-gray-100">AWS S3</div>
                  </button>
                  <button 
                    onClick={() => handleCloudSync('dropbox')}
                    className="p-4 rounded-xl border border-gray-200 dark:border-gray-700 hover:bg-indigo-50 dark:hover:bg-indigo-900/20 transition-colors"
                  >
                    <CloudIcon className="w-8 h-8 text-indigo-500 mx-auto mb-2" />
                    <div className="text-xs font-medium text-gray-900 dark:text-gray-100">Dropbox</div>
                  </button>
                </div>
                
                <div>
                  <h4 className="font-semibold text-gray-900 dark:text-gray-100 mb-3">ë™ê¸°í™” ìƒíƒœ</h4>
                  <div className="space-y-3">
                    <div className="flex items-center justify-between p-3 rounded-lg border border-gray-200 dark:border-gray-700">
                      <div className="flex items-center space-x-3">
                        <div className="w-3 h-3 bg-green-500 rounded-full"></div>
                        <span className="text-gray-900 dark:text-gray-100">Google Drive</span>
                      </div>
                      <span className="text-green-600 dark:text-green-400 text-sm">ì—°ê²°ë¨</span>
                    </div>
                    <div className="flex items-center justify-between p-3 rounded-lg border border-gray-200 dark:border-gray-700">
                      <div className="flex items-center space-x-3">
                        <div className="w-3 h-3 bg-gray-400 rounded-full"></div>
                        <span className="text-gray-900 dark:text-gray-100">AWS S3</span>
                      </div>
                      <button 
                        onClick={() => handleCloudUpload('aws')}
                        className="text-blue-600 dark:text-blue-400 text-sm hover:underline"
                      >
                        ì—°ê²°
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        )}

        {/* ì‚¬ìš©ìž í”„ë¡œí•„ íŒì—… ë©”ë‰´ */}
        {userProfilePopup.show && userProfilePopup.user && (
          <div 
            className="fixed z-[70] bg-white/95 dark:bg-gray-900/95 backdrop-blur-xl rounded-2xl shadow-2xl border border-gray-200/50 dark:border-gray-700/50 min-w-[280px] p-4"
            style={{ 
              left: `${userProfilePopup.x}px`, 
              top: `${userProfilePopup.y}px`,
              transform: userProfilePopup.x > window.innerWidth - 300 ? 'translateX(-100%)' : 'none'
            }}
            onClick={(e) => e.stopPropagation()}
          >
            {/* ì‚¬ìš©ìž ì •ë³´ í—¤ë” */}
            <div className="flex items-center space-x-3 mb-4 pb-4 border-b border-gray-200 dark:border-gray-700">
              <div className="relative">
                <div className={`w-12 h-12 rounded-xl bg-gradient-to-br ${userProfilePopup.user.avatarColor} flex items-center justify-center text-white font-bold shadow-lg`}>
                  {userProfilePopup.user.avatar}
                </div>
                <div className={`absolute -bottom-1 -right-1 w-4 h-4 rounded-full border-2 border-white ${
                  userProfilePopup.user.status === 'online' ? 'bg-green-500' : 
                  userProfilePopup.user.status === 'away' ? 'bg-yellow-500' : 
                  userProfilePopup.user.status === 'busy' ? 'bg-red-500' : 'bg-gray-400'
                }`}></div>
              </div>
              <div className="flex-1">
                <div className="font-bold text-gray-900 dark:text-gray-100">{userProfilePopup.user.name}</div>
                <div className="text-sm text-gray-600 dark:text-gray-400">{userProfilePopup.user.title}</div>
                <div className={`text-xs font-medium ${
                  userProfilePopup.user.status === 'online' ? 'text-green-600 dark:text-green-400' : 
                  userProfilePopup.user.status === 'away' ? 'text-yellow-600 dark:text-yellow-400' : 
                  userProfilePopup.user.status === 'busy' ? 'text-red-600 dark:text-red-400' : 'text-gray-400'
                }`}>
                  {userProfilePopup.user.status === 'online' ? 'ì˜¨ë¼ì¸' : 
                   userProfilePopup.user.status === 'away' ? 'ìžë¦¬ë¹„ì›€' : 
                   userProfilePopup.user.status === 'busy' ? 'ë°”ì¨' : 'ì˜¤í”„ë¼ì¸'}
                </div>
              </div>
            </div>

            {/* í˜„ìž¬ í™œë™ ì •ë³´ */}
            {userProfilePopup.user.currentActivity && (
              <div className="mb-4 p-3 bg-blue-50 dark:bg-blue-900/20 rounded-xl">
                <div className="text-sm font-medium text-blue-900 dark:text-blue-100 mb-1">
                  ðŸ“„ í˜„ìž¬ í™œë™
                </div>
                <div className="text-sm text-blue-700 dark:text-blue-300 truncate">
                  {userProfilePopup.user.currentActivity.file}
                </div>
                <div className="text-xs text-blue-600 dark:text-blue-400">
                  {userProfilePopup.user.currentActivity.action} â€¢ {formatTimeAgo(userProfilePopup.user.currentActivity.timestamp)}
                </div>
              </div>
            )}

            {/* ì•¡ì…˜ ë²„íŠ¼ë“¤ */}
            <div className="space-y-2">
              <button
                onClick={() => sendMessageToUser(userProfilePopup.user.id, `ì•ˆë…•í•˜ì„¸ìš” ${userProfilePopup.user.name}ë‹˜!`)}
                className="w-full flex items-center space-x-3 p-3 rounded-xl hover:bg-blue-50 dark:hover:bg-blue-900/20 transition-colors text-left"
              >
                <ChatBubbleLeftRightIcon className="w-5 h-5 text-blue-500" />
                <span className="text-gray-900 dark:text-gray-100">ë©”ì‹œì§€ ë³´ë‚´ê¸°</span>
              </button>
              
              {currentUserActivity.viewingFile && (
                <button
                  onClick={() => shareFileWithUser(userProfilePopup.user.id, currentUserActivity.viewingFile)}
                  className="w-full flex items-center space-x-3 p-3 rounded-xl hover:bg-green-50 dark:hover:bg-green-900/20 transition-colors text-left"
                >
                  <DocumentIcon className="w-5 h-5 text-green-500" />
                  <span className="text-gray-900 dark:text-gray-100">í˜„ìž¬ íŒŒì¼ ê³µìœ </span>
                </button>
              )}
              
              <button
                onClick={() => {
                  console.log(`${userProfilePopup.user.name}ë‹˜ê³¼ í™”ìƒ í†µí™” ì‹œìž‘`);
                  setUserProfilePopup({ show: false, user: null, x: 0, y: 0 });
                }}
                className="w-full flex items-center space-x-3 p-3 rounded-xl hover:bg-purple-50 dark:hover:bg-purple-900/20 transition-colors text-left"
              >
                <VideoCameraIcon className="w-5 h-5 text-purple-500" />
                <span className="text-gray-900 dark:text-gray-100">í™”ìƒ í†µí™”</span>
              </button>
              
              <button
                onClick={() => {
                  console.log(`${userProfilePopup.user.name}ë‹˜ì˜ ìƒì„¸ í”„ë¡œí•„ ë³´ê¸°`);
                  setUserProfilePopup({ show: false, user: null, x: 0, y: 0 });
                }}
                className="w-full flex items-center space-x-3 p-3 rounded-xl hover:bg-gray-50 dark:hover:bg-gray-800 transition-colors text-left"
              >
                <EyeIcon className="w-5 h-5 text-gray-500" />
                <span className="text-gray-900 dark:text-gray-100">í”„ë¡œí•„ ë³´ê¸°</span>
              </button>
            </div>
          </div>
        )}
        </div>
      </div>
      
    </div>
  );
}